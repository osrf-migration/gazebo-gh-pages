{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "links": {"attachments": {"href": "data/repositories/osrf/gazebo/issues/2493/attachments_page=1.json"}, "self": {"href": "data/repositories/osrf/gazebo/issues/2493.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/issues/2493/watch"}, "comments": {"href": "data/repositories/osrf/gazebo/issues/2493/comments_page=1.json"}, "html": {"href": "#!/osrf/gazebo/issues/2493/a-bug-in-setclipdist-in-rendering"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/issues/2493/vote"}}, "reporter": {"display_name": "Huang Fan", "uuid": "{257c3fe5-11e0-445e-b0e3-da3ee68633e1}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B257c3fe5-11e0-445e-b0e3-da3ee68633e1%7D"}, "html": {"href": "https://bitbucket.org/%7B257c3fe5-11e0-445e-b0e3-da3ee68633e1%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/a5d640cbda9f9296ed67a4e78c8f6e0cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsHF-2.png"}}, "nickname": "clawinshadow", "type": "user", "account_id": "5b3f4a2519502f2ea53aa82e"}, "title": "A bug in SetClipDist() in rendering::WideAngleCamera", "component": {"name": "rendering", "links": {"self": {"href": "data/repositories/osrf/gazebo/components/122881.json"}}}, "votes": 0, "watches": 1, "content": {"raw": "In this function, only  env cameras were set with the near & clip distances, while the base camera remain the old values. Despite wide angle camera rendering images only use the 6 env cameras, I think it's still necessary to initialize the clip distances of base camera, because  some other functions like isVisible() are still using the base camera. If we don't initialize the clip distances of base camera, some issue that a Visual is visible in a Camera whereas invisible in a wide angle camera with the same frustum will probably be happen(already happened in my project)\r\n\r\n\r\n```\r\n#!c++\r\n\r\nvoid WideAngleCamera::SetClipDist()\r\n{\r\n  std::lock_guard<std::mutex> lock(this->dataPtr->dataMutex);\r\n\r\n  // <clip> element presence is already checked\r\n  // in Camera::SetClipDist(float,float)\r\n  sdf::ElementPtr clipElem = this->sdf->GetElement(\"clip\");\r\n\r\n  for (int i = 0; i < 6; ++i)\r\n  {\r\n    if (this->dataPtr->envCameras[i])\r\n    {\r\n      this->dataPtr->envCameras[i]->setNearClipDistance(\r\n          clipElem->Get<double>(\"near\"));\r\n      this->dataPtr->envCameras[i]->setFarClipDistance(\r\n          clipElem->Get<double>(\"far\"));\r\n      this->dataPtr->envCameras[i]->setRenderingDistance(\r\n          clipElem->Get<double>(\"far\"));\r\n    }\r\n    else\r\n    {\r\n      gzerr << \"Setting clip distances failed - no camera yet\" << std::endl;\r\n\r\n      break;\r\n    }\r\n  }\r\n}\r\n```", "markup": "markdown", "html": "<p>In this function, only  env cameras were set with the near &amp; clip distances, while the base camera remain the old values. Despite wide angle camera rendering images only use the 6 env cameras, I think it's still necessary to initialize the clip distances of base camera, because  some other functions like isVisible() are still using the base camera. If we don't initialize the clip distances of base camera, some issue that a Visual is visible in a Camera whereas invisible in a wide angle camera with the same frustum will probably be happen(already happened in my project)</p>\n<div class=\"codehilite language-c++\"><pre><span></span><span class=\"kt\">void</span> <span class=\"n\">WideAngleCamera</span><span class=\"o\">::</span><span class=\"n\">SetClipDist</span><span class=\"p\">()</span>\n<span class=\"p\">{</span>\n  <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">lock_guard</span><span class=\"o\">&lt;</span><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">mutex</span><span class=\"o\">&gt;</span> <span class=\"n\">lock</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">dataPtr</span><span class=\"o\">-&gt;</span><span class=\"n\">dataMutex</span><span class=\"p\">);</span>\n\n  <span class=\"c1\">// &lt;clip&gt; element presence is already checked</span>\n  <span class=\"c1\">// in Camera::SetClipDist(float,float)</span>\n  <span class=\"n\">sdf</span><span class=\"o\">::</span><span class=\"n\">ElementPtr</span> <span class=\"n\">clipElem</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">sdf</span><span class=\"o\">-&gt;</span><span class=\"n\">GetElement</span><span class=\"p\">(</span><span class=\"s\">&quot;clip&quot;</span><span class=\"p\">);</span>\n\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kt\">int</span> <span class=\"n\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"n\">i</span> <span class=\"o\">&lt;</span> <span class=\"mi\">6</span><span class=\"p\">;</span> <span class=\"o\">++</span><span class=\"n\">i</span><span class=\"p\">)</span>\n  <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">dataPtr</span><span class=\"o\">-&gt;</span><span class=\"n\">envCameras</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">])</span>\n    <span class=\"p\">{</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">dataPtr</span><span class=\"o\">-&gt;</span><span class=\"n\">envCameras</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"o\">-&gt;</span><span class=\"n\">setNearClipDistance</span><span class=\"p\">(</span>\n          <span class=\"n\">clipElem</span><span class=\"o\">-&gt;</span><span class=\"n\">Get</span><span class=\"o\">&lt;</span><span class=\"kt\">double</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;near&quot;</span><span class=\"p\">));</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">dataPtr</span><span class=\"o\">-&gt;</span><span class=\"n\">envCameras</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"o\">-&gt;</span><span class=\"n\">setFarClipDistance</span><span class=\"p\">(</span>\n          <span class=\"n\">clipElem</span><span class=\"o\">-&gt;</span><span class=\"n\">Get</span><span class=\"o\">&lt;</span><span class=\"kt\">double</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;far&quot;</span><span class=\"p\">));</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">dataPtr</span><span class=\"o\">-&gt;</span><span class=\"n\">envCameras</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span><span class=\"o\">-&gt;</span><span class=\"n\">setRenderingDistance</span><span class=\"p\">(</span>\n          <span class=\"n\">clipElem</span><span class=\"o\">-&gt;</span><span class=\"n\">Get</span><span class=\"o\">&lt;</span><span class=\"kt\">double</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;far&quot;</span><span class=\"p\">));</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">else</span>\n    <span class=\"p\">{</span>\n      <span class=\"n\">gzerr</span> <span class=\"o\">&lt;&lt;</span> <span class=\"s\">&quot;Setting clip distances failed - no camera yet&quot;</span> <span class=\"o\">&lt;&lt;</span> <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n\n      <span class=\"k\">break</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</pre></div>", "type": "rendered"}, "assignee": null, "state": "new", "version": {"name": "9.0", "links": {"self": {"href": "data/repositories/osrf/gazebo/versions/242746.json"}}}, "edited_on": null, "created_on": "2018-07-06T11:18:02.047732+00:00", "milestone": null, "updated_on": "2018-08-04T01:05:49.136601+00:00", "type": "issue", "id": 2493}