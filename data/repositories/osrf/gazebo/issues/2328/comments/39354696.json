{"links": {"self": {"href": "data/repositories/osrf/gazebo/issues/2328/comments/39354696.json"}, "html": {"href": "#!/osrf/gazebo/issues/2328#comment-39354696"}}, "issue": {"links": {"self": {"href": "data/repositories/osrf/gazebo/issues/2328.json"}}, "type": "issue", "id": 2328, "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "title": "Programatically updating lights yields a false error"}, "content": {"raw": "I think the problem is a race condition when two or more lights are created under high load on startup. My intuition says that maybe the world update is called before the create publisher is flushed. This puts the system in a bad state, and causes the error to be printed incorrectly on each subsequent world update.\n\nThis code fails 50% of the time for me.\n\n```\n#!c++\n\n#include <gazebo/gazebo.hh>\n\nnamespace gazebo\n{\n  class SpawnLight : public ModelPlugin\n  {\n    public: SpawnLight() : ModelPlugin()\n    {\n    }\n\n    public: void Load(physics::ModelPtr model, sdf::ElementPtr sdf)\n    {\n      this->node = transport::NodePtr(new transport::Node());\n      this->node->Init();\n      this->pubCreate = this->node->Advertise<msgs::Light>(\"~/factory/light\");\n      this->pubUpdate = this->node->Advertise<msgs::Light>(\"~/light/modify\");\n      this->lightName1 = \"new1_light\";\n      this->lightName2 = \"new2_light\";\n\n      msgs::Light msg;\n\n      msg.set_name(this->lightName1);\n      msgs::Set(msg.mutable_diffuse(), common::Color(0.5, 0.0, 0.0, 1));\n      msgs::Set(msg.mutable_specular(), common::Color(0.0, 0.8, 0.1, 1));\n      msgs::Set(msg.mutable_pose(), ignition::math::Pose3d(0, 0, 1, 0, 0, 0));\n      this->pubCreate->Publish(msg);\n\n      msg.set_name(this->lightName2);\n      msgs::Set(msg.mutable_diffuse(), common::Color(0.5, 0.0, 0.0, 1));\n      msgs::Set(msg.mutable_specular(), common::Color(0.0, 0.8, 0.1, 1));\n      msgs::Set(msg.mutable_pose(), ignition::math::Pose3d(0, 0, 1, 0, 0, 0));\n      this->pubCreate->Publish(msg);\n\n      this->updateConnection = event::Events::ConnectWorldUpdateBegin(\n          std::bind(&SpawnLight::OnUpdate, this, std::placeholders::_1));\n    }\n\n    public: void OnUpdate(const common::UpdateInfo &_info)\n    {\n      double offset = _info.simTime.Double() / 10;\n\n      msgs::Light msg;\n\n      msg.set_name(this->lightName1);\n      msgs::Set(msg.mutable_pose(),\n          ignition::math::Pose3d(offset, offset, 1, 0, 0, 0));\n      this->pubUpdate->Publish(msg);\n\n      msg.set_name(this->lightName2);\n      msgs::Set(msg.mutable_pose(),\n          ignition::math::Pose3d(offset, offset, 1, 0, 0, 0));\n      this->pubUpdate->Publish(msg);\n\n    }\n\n    private: event::ConnectionPtr updateConnection;\n    private: transport::PublisherPtr pubCreate;\n    private: transport::PublisherPtr pubUpdate;\n    private: transport::NodePtr node;\n    private: std::string lightName1, lightName2;\n  };\n  GZ_REGISTER_MODEL_PLUGIN(SpawnLight)\n}\n```", "markup": "markdown", "html": "<p>I think the problem is a race condition when two or more lights are created under high load on startup. My intuition says that maybe the world update is called before the create publisher is flushed. This puts the system in a bad state, and causes the error to be printed incorrectly on each subsequent world update.</p>\n<p>This code fails 50% of the time for me.</p>\n<div class=\"codehilite language-c++\"><pre><span></span><span class=\"cp\">#include</span> <span class=\"cpf\">&lt;gazebo/gazebo.hh&gt;</span><span class=\"cp\"></span>\n\n<span class=\"k\">namespace</span> <span class=\"n\">gazebo</span>\n<span class=\"p\">{</span>\n  <span class=\"k\">class</span> <span class=\"nc\">SpawnLight</span> <span class=\"o\">:</span> <span class=\"k\">public</span> <span class=\"n\">ModelPlugin</span>\n  <span class=\"p\">{</span>\n    <span class=\"k\">public</span><span class=\"o\">:</span> <span class=\"n\">SpawnLight</span><span class=\"p\">()</span> <span class=\"o\">:</span> <span class=\"n\">ModelPlugin</span><span class=\"p\">()</span>\n    <span class=\"p\">{</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">public</span><span class=\"o\">:</span> <span class=\"kt\">void</span> <span class=\"n\">Load</span><span class=\"p\">(</span><span class=\"n\">physics</span><span class=\"o\">::</span><span class=\"n\">ModelPtr</span> <span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">sdf</span><span class=\"o\">::</span><span class=\"n\">ElementPtr</span> <span class=\"n\">sdf</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">node</span> <span class=\"o\">=</span> <span class=\"n\">transport</span><span class=\"o\">::</span><span class=\"n\">NodePtr</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"n\">transport</span><span class=\"o\">::</span><span class=\"n\">Node</span><span class=\"p\">());</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">node</span><span class=\"o\">-&gt;</span><span class=\"n\">Init</span><span class=\"p\">();</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">pubCreate</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">node</span><span class=\"o\">-&gt;</span><span class=\"n\">Advertise</span><span class=\"o\">&lt;</span><span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Light</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;~/factory/light&quot;</span><span class=\"p\">);</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">pubUpdate</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">node</span><span class=\"o\">-&gt;</span><span class=\"n\">Advertise</span><span class=\"o\">&lt;</span><span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Light</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"s\">&quot;~/light/modify&quot;</span><span class=\"p\">);</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">lightName1</span> <span class=\"o\">=</span> <span class=\"s\">&quot;new1_light&quot;</span><span class=\"p\">;</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">lightName2</span> <span class=\"o\">=</span> <span class=\"s\">&quot;new2_light&quot;</span><span class=\"p\">;</span>\n\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Light</span> <span class=\"n\">msg</span><span class=\"p\">;</span>\n\n      <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">set_name</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">lightName1</span><span class=\"p\">);</span>\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Set</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">mutable_diffuse</span><span class=\"p\">(),</span> <span class=\"n\">common</span><span class=\"o\">::</span><span class=\"n\">Color</span><span class=\"p\">(</span><span class=\"mf\">0.5</span><span class=\"p\">,</span> <span class=\"mf\">0.0</span><span class=\"p\">,</span> <span class=\"mf\">0.0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">));</span>\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Set</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">mutable_specular</span><span class=\"p\">(),</span> <span class=\"n\">common</span><span class=\"o\">::</span><span class=\"n\">Color</span><span class=\"p\">(</span><span class=\"mf\">0.0</span><span class=\"p\">,</span> <span class=\"mf\">0.8</span><span class=\"p\">,</span> <span class=\"mf\">0.1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">));</span>\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Set</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">mutable_pose</span><span class=\"p\">(),</span> <span class=\"n\">ignition</span><span class=\"o\">::</span><span class=\"n\">math</span><span class=\"o\">::</span><span class=\"n\">Pose3d</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">));</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">pubCreate</span><span class=\"o\">-&gt;</span><span class=\"n\">Publish</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">);</span>\n\n      <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">set_name</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">lightName2</span><span class=\"p\">);</span>\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Set</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">mutable_diffuse</span><span class=\"p\">(),</span> <span class=\"n\">common</span><span class=\"o\">::</span><span class=\"n\">Color</span><span class=\"p\">(</span><span class=\"mf\">0.5</span><span class=\"p\">,</span> <span class=\"mf\">0.0</span><span class=\"p\">,</span> <span class=\"mf\">0.0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">));</span>\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Set</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">mutable_specular</span><span class=\"p\">(),</span> <span class=\"n\">common</span><span class=\"o\">::</span><span class=\"n\">Color</span><span class=\"p\">(</span><span class=\"mf\">0.0</span><span class=\"p\">,</span> <span class=\"mf\">0.8</span><span class=\"p\">,</span> <span class=\"mf\">0.1</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">));</span>\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Set</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">mutable_pose</span><span class=\"p\">(),</span> <span class=\"n\">ignition</span><span class=\"o\">::</span><span class=\"n\">math</span><span class=\"o\">::</span><span class=\"n\">Pose3d</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">));</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">pubCreate</span><span class=\"o\">-&gt;</span><span class=\"n\">Publish</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">);</span>\n\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">updateConnection</span> <span class=\"o\">=</span> <span class=\"n\">event</span><span class=\"o\">::</span><span class=\"n\">Events</span><span class=\"o\">::</span><span class=\"n\">ConnectWorldUpdateBegin</span><span class=\"p\">(</span>\n          <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">SpawnLight</span><span class=\"o\">::</span><span class=\"n\">OnUpdate</span><span class=\"p\">,</span> <span class=\"k\">this</span><span class=\"p\">,</span> <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">placeholders</span><span class=\"o\">::</span><span class=\"n\">_1</span><span class=\"p\">));</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">public</span><span class=\"o\">:</span> <span class=\"kt\">void</span> <span class=\"n\">OnUpdate</span><span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"n\">common</span><span class=\"o\">::</span><span class=\"n\">UpdateInfo</span> <span class=\"o\">&amp;</span><span class=\"n\">_info</span><span class=\"p\">)</span>\n    <span class=\"p\">{</span>\n      <span class=\"kt\">double</span> <span class=\"n\">offset</span> <span class=\"o\">=</span> <span class=\"n\">_info</span><span class=\"p\">.</span><span class=\"n\">simTime</span><span class=\"p\">.</span><span class=\"n\">Double</span><span class=\"p\">()</span> <span class=\"o\">/</span> <span class=\"mi\">10</span><span class=\"p\">;</span>\n\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Light</span> <span class=\"n\">msg</span><span class=\"p\">;</span>\n\n      <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">set_name</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">lightName1</span><span class=\"p\">);</span>\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Set</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">mutable_pose</span><span class=\"p\">(),</span>\n          <span class=\"n\">ignition</span><span class=\"o\">::</span><span class=\"n\">math</span><span class=\"o\">::</span><span class=\"n\">Pose3d</span><span class=\"p\">(</span><span class=\"n\">offset</span><span class=\"p\">,</span> <span class=\"n\">offset</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">));</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">pubUpdate</span><span class=\"o\">-&gt;</span><span class=\"n\">Publish</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">);</span>\n\n      <span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">set_name</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">lightName2</span><span class=\"p\">);</span>\n      <span class=\"n\">msgs</span><span class=\"o\">::</span><span class=\"n\">Set</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">.</span><span class=\"n\">mutable_pose</span><span class=\"p\">(),</span>\n          <span class=\"n\">ignition</span><span class=\"o\">::</span><span class=\"n\">math</span><span class=\"o\">::</span><span class=\"n\">Pose3d</span><span class=\"p\">(</span><span class=\"n\">offset</span><span class=\"p\">,</span> <span class=\"n\">offset</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">));</span>\n      <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">pubUpdate</span><span class=\"o\">-&gt;</span><span class=\"n\">Publish</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">);</span>\n\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">private</span><span class=\"o\">:</span> <span class=\"n\">event</span><span class=\"o\">::</span><span class=\"n\">ConnectionPtr</span> <span class=\"n\">updateConnection</span><span class=\"p\">;</span>\n    <span class=\"k\">private</span><span class=\"o\">:</span> <span class=\"n\">transport</span><span class=\"o\">::</span><span class=\"n\">PublisherPtr</span> <span class=\"n\">pubCreate</span><span class=\"p\">;</span>\n    <span class=\"k\">private</span><span class=\"o\">:</span> <span class=\"n\">transport</span><span class=\"o\">::</span><span class=\"n\">PublisherPtr</span> <span class=\"n\">pubUpdate</span><span class=\"p\">;</span>\n    <span class=\"k\">private</span><span class=\"o\">:</span> <span class=\"n\">transport</span><span class=\"o\">::</span><span class=\"n\">NodePtr</span> <span class=\"n\">node</span><span class=\"p\">;</span>\n    <span class=\"k\">private</span><span class=\"o\">:</span> <span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">string</span> <span class=\"n\">lightName1</span><span class=\"p\">,</span> <span class=\"n\">lightName2</span><span class=\"p\">;</span>\n  <span class=\"p\">};</span>\n  <span class=\"n\">GZ_REGISTER_MODEL_PLUGIN</span><span class=\"p\">(</span><span class=\"n\">SpawnLight</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n</pre></div>", "type": "rendered"}, "created_on": "2017-08-26T00:42:53.045361+00:00", "user": {"display_name": "Andrew Symington", "uuid": "{db1311fc-02e6-442e-84a1-4bb85dfee5ba}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bdb1311fc-02e6-442e-84a1-4bb85dfee5ba%7D"}, "html": {"href": "https://bitbucket.org/%7Bdb1311fc-02e6-442e-84a1-4bb85dfee5ba%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:cab3b56e-7c24-487c-b07f-05e0600adf54/8a009f21-29b8-4d43-98ed-2677428e17ff/128"}}, "nickname": "asymingt", "type": "user", "account_id": "557058:cab3b56e-7c24-487c-b07f-05e0600adf54"}, "updated_on": null, "type": "issue_comment", "id": 39354696}