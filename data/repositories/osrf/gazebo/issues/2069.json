{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "links": {"attachments": {"href": "data/repositories/osrf/gazebo/issues/2069/attachments_page=1.json"}, "self": {"href": "data/repositories/osrf/gazebo/issues/2069.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/issues/2069/watch"}, "comments": {"href": "data/repositories/osrf/gazebo/issues/2069/comments_page=1.json"}, "html": {"href": "#!/osrf/gazebo/issues/2069/factory-messages-arent-always-received-in"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/issues/2069/vote"}}, "reporter": {"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}, "title": "Factory messages aren't always received in gzTest.Model", "component": {"name": "tools", "links": {"self": {"href": "data/repositories/osrf/gazebo/components/132355.json"}}}, "votes": 0, "watches": 1, "content": {"raw": "I've been looking into the `gzTest.Model` failures in `UNIT_gz_TEST`, which fail very frequently on homebrew. I have made some improvements in the [gz_test_race branch](#!/osrf/gazebo/branches/compare/gz_test_race%0Dgazebo7), but there is still one flaky failure that I can't figure out.\r\n\r\n[This gazebo7 homebrew build](http://build.osrfoundation.org/job/gazebo-ci-gazebo7-homebrew-amd64/84/console) has the test failing twice with the following console output:\r\n\r\n~~~\r\n515: [ RUN      ] gzTest.Model\r\n515: [Msg] Waiting for master.\r\n515: [Msg] Connected to gazebo master @ http://127.0.0.1:11345\r\n515: [Msg] Publicized address: 172.23.2.252\r\n515: tools/gz_TEST.cc:325: Failure\r\n515: Value of: g_msgDebugOut.empty()\r\n515:   Actual: true\r\n515: Expected: false\r\n515: tools/gz_TEST.cc:340: Failure\r\n515: Value of: msg.DebugString()\r\n515:   Actual: \"sdf: \\\"<?xml version=\\\\'1.0\\\\'?>\\\\n<sdf version=\\\\'1.6\\\\'>\\\\n  <model name=\\\\'my_box\\\\'>\\\\n    <pose frame=\\\\'\\\\'>0 0 0.5 0 -0 0</pose>\\\\n    <link name=\\\\'link\\\\'>\\\\n      <collision name=\\\\'collision\\\\'>\\\\n        <geometry>\\\\n          <box>\\\\n            <size>1 1 1</size>\\\\n          </box>\\\\n        </geometry>\\\\n      </collision>\\\\n      <visual name=\\\\'visual\\\\'>\\\\n        <geometry>\\\\n          <box>\\\\n            <size>1 1 1</size>\\\\n          </box>\\\\n        </geometry>\\\\n        <material>\\\\n          <script>\\\\n            <uri>__default__</uri>\\\\n            <name>__default__</name>\\\\n          </script>\\\\n        </material>\\\\n      </visual>\\\\n    </link>\\\\n  </model>\\\\n</sdf>\\\\n\\\"\\npose {\\n  position {\\n    x: 0\\n    y: 0\\n    z: 0\\n  }\\n  orientation {\\n    x: 0\\n    y: 0\\n    z: 0\\n    w: 1\\n  }\\n}\\n\"\r\n515: Expected: g_msgDebugOut\r\n515: Which is: \"\"\r\n515: tools/gz_TEST.cc:462: Failure\r\n515: Expected: (g_msgDebugOut.find(\"simple_arm\")) != (std::string::npos), actual: 18446744073709551615 vs 18446744073709551615\r\n515: [  FAILED  ] gzTest.Model (7045 ms)\r\n~~~\r\n\r\n~~~\r\n515: [ RUN      ] gzTest.Model\r\n515: [Msg] Waiting for master.\r\n515: [Msg] Connected to gazebo master @ http://127.0.0.1:11345\r\n515: [Msg] Publicized address: 172.23.2.252\r\n515: tools/gz_TEST.cc:325: Failure\r\n515: Value of: g_msgDebugOut.empty()\r\n515:   Actual: true\r\n515: Expected: false\r\n515: tools/gz_TEST.cc:340: Failure\r\n515: Value of: msg.DebugString()\r\n515:   Actual: \"sdf: \\\"<?xml version=\\\\'1.0\\\\'?>\\\\n<sdf version=\\\\'1.6\\\\'>\\\\n  <model name=\\\\'my_box\\\\'>\\\\n    <pose frame=\\\\'\\\\'>0 0 0.5 0 -0 0</pose>\\\\n    <link name=\\\\'link\\\\'>\\\\n      <collision name=\\\\'collision\\\\'>\\\\n        <geometry>\\\\n          <box>\\\\n            <size>1 1 1</size>\\\\n          </box>\\\\n        </geometry>\\\\n      </collision>\\\\n      <visual name=\\\\'visual\\\\'>\\\\n        <geometry>\\\\n          <box>\\\\n            <size>1 1 1</size>\\\\n          </box>\\\\n        </geometry>\\\\n        <material>\\\\n          <script>\\\\n            <uri>__default__</uri>\\\\n            <name>__default__</name>\\\\n          </script>\\\\n        </material>\\\\n      </visual>\\\\n    </link>\\\\n  </model>\\\\n</sdf>\\\\n\\\"\\npose {\\n  position {\\n    x: 0\\n    y: 0\\n    z: 0\\n  }\\n  orientation {\\n    x: 0\\n    y: 0\\n    z: 0\\n    w: 1\\n  }\\n}\\n\"\r\n515: Expected: g_msgDebugOut\r\n515: Which is: \"\"\r\n515: tools/gz_TEST.cc:389: Failure\r\n515: Value of: g_msgDebugOut.empty()\r\n515:   Actual: true\r\n515: Expected: false\r\n515: tools/gz_TEST.cc:404: Failure\r\n515: Value of: msg.DebugString()\r\n515:   Actual: \"sdf: \\\"<?xml version=\\\\'1.0\\\\'?>\\\\n<sdf version=\\\\'1.6\\\\'>\\\\n  <model name=\\\\'my_box\\\\'>\\\\n    <pose frame=\\\\'\\\\'>0 0 0.5 0 -0 0</pose>\\\\n    <link name=\\\\'link\\\\'>\\\\n      <collision name=\\\\'collision\\\\'>\\\\n        <geometry>\\\\n          <box>\\\\n            <size>1 1 1</size>\\\\n          </box>\\\\n        </geometry>\\\\n      </collision>\\\\n      <visual name=\\\\'visual\\\\'>\\\\n        <geometry>\\\\n          <box>\\\\n            <size>1 1 1</size>\\\\n          </box>\\\\n        </geometry>\\\\n        <material>\\\\n          <script>\\\\n            <uri>__default__</uri>\\\\n            <name>__default__</name>\\\\n          </script>\\\\n        </material>\\\\n      </visual>\\\\n    </link>\\\\n  </model>\\\\n</sdf>\\\\n\\\"\\npose {\\n  position {\\n    x: 0\\n    y: 0\\n    z: 0\\n  }\\n  orientation {\\n    x: 0\\n    y: 0\\n    z: 0\\n    w: 1\\n  }\\n}\\n\"\r\n515: Expected: g_msgDebugOut\r\n515: Which is: \"\"\r\n515: [  FAILED  ] gzTest.Model (7623 ms)\r\n~~~\r\n\r\nIgnoring the failed expectation at line 462, since that is fixed in the `gz_test_race` branch, there are failure at lines 325/340 twice and 389/404 once. Each of these expectations involves invoking `gz model` to spawn a `my_box` model and waiting for a subscriber to `~/factory` to receive the message. These expectations usually pass on my Ubuntu machine, but usually fail on homebrew. The strange thing is that there are other expectations that get model info and pass, so the model must exist. It seems that the only thing failing is the receipt of the `~/factory` by the gtest executable.", "markup": "markdown", "html": "<p>I've been looking into the <code>gzTest.Model</code> failures in <code>UNIT_gz_TEST</code>, which fail very frequently on homebrew. I have made some improvements in the <a data-is-external-link=\"true\" href=\"#!/osrf/gazebo/branches/compare/gz_test_race%0Dgazebo7\" rel=\"nofollow\">gz_test_race branch</a>, but there is still one flaky failure that I can't figure out.</p>\n<p><a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-ci-gazebo7-homebrew-amd64/84/console\" rel=\"nofollow\">This gazebo7 homebrew build</a> has the test failing twice with the following console output:</p>\n<div class=\"codehilite\"><pre><span></span>515: [ RUN      ] gzTest.Model\n515: [Msg] Waiting for master.\n515: [Msg] Connected to gazebo master @ http://127.0.0.1:11345\n515: [Msg] Publicized address: 172.23.2.252\n515: tools/gz_TEST.cc:325: Failure\n515: Value of: g_msgDebugOut.empty()\n515:   Actual: true\n515: Expected: false\n515: tools/gz_TEST.cc:340: Failure\n515: Value of: msg.DebugString()\n515:   Actual: &quot;sdf: \\&quot;<span class=\"cp\">&lt;?xml version=\\\\&#39;1.0\\\\&#39;?&gt;</span>\\\\n<span class=\"nt\">&lt;sdf</span> <span class=\"na\">version=</span><span class=\"s\">\\\\&#39;1.6\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n  <span class=\"nt\">&lt;model</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;my_box\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n    <span class=\"nt\">&lt;pose</span> <span class=\"na\">frame=</span><span class=\"s\">\\\\&#39;\\\\&#39;</span><span class=\"nt\">&gt;</span>0 0 0.5 0 -0 0<span class=\"nt\">&lt;/pose&gt;</span>\\\\n    <span class=\"nt\">&lt;link</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;link\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n      <span class=\"nt\">&lt;collision</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;collision\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n        <span class=\"nt\">&lt;geometry&gt;</span>\\\\n          <span class=\"nt\">&lt;box&gt;</span>\\\\n            <span class=\"nt\">&lt;size&gt;</span>1 1 1<span class=\"nt\">&lt;/size&gt;</span>\\\\n          <span class=\"nt\">&lt;/box&gt;</span>\\\\n        <span class=\"nt\">&lt;/geometry&gt;</span>\\\\n      <span class=\"nt\">&lt;/collision&gt;</span>\\\\n      <span class=\"nt\">&lt;visual</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;visual\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n        <span class=\"nt\">&lt;geometry&gt;</span>\\\\n          <span class=\"nt\">&lt;box&gt;</span>\\\\n            <span class=\"nt\">&lt;size&gt;</span>1 1 1<span class=\"nt\">&lt;/size&gt;</span>\\\\n          <span class=\"nt\">&lt;/box&gt;</span>\\\\n        <span class=\"nt\">&lt;/geometry&gt;</span>\\\\n        <span class=\"nt\">&lt;material&gt;</span>\\\\n          <span class=\"nt\">&lt;script&gt;</span>\\\\n            <span class=\"nt\">&lt;uri&gt;</span>__default__<span class=\"nt\">&lt;/uri&gt;</span>\\\\n            <span class=\"nt\">&lt;name&gt;</span>__default__<span class=\"nt\">&lt;/name&gt;</span>\\\\n          <span class=\"nt\">&lt;/script&gt;</span>\\\\n        <span class=\"nt\">&lt;/material&gt;</span>\\\\n      <span class=\"nt\">&lt;/visual&gt;</span>\\\\n    <span class=\"nt\">&lt;/link&gt;</span>\\\\n  <span class=\"nt\">&lt;/model&gt;</span>\\\\n<span class=\"nt\">&lt;/sdf&gt;</span>\\\\n\\&quot;\\npose {\\n  position {\\n    x: 0\\n    y: 0\\n    z: 0\\n  }\\n  orientation {\\n    x: 0\\n    y: 0\\n    z: 0\\n    w: 1\\n  }\\n}\\n&quot;\n515: Expected: g_msgDebugOut\n515: Which is: &quot;&quot;\n515: tools/gz_TEST.cc:462: Failure\n515: Expected: (g_msgDebugOut.find(&quot;simple_arm&quot;)) != (std::string::npos), actual: 18446744073709551615 vs 18446744073709551615\n515: [  FAILED  ] gzTest.Model (7045 ms)\n</pre></div>\n\n\n<div class=\"codehilite\"><pre><span></span>515: [ RUN      ] gzTest.Model\n515: [Msg] Waiting for master.\n515: [Msg] Connected to gazebo master @ http://127.0.0.1:11345\n515: [Msg] Publicized address: 172.23.2.252\n515: tools/gz_TEST.cc:325: Failure\n515: Value of: g_msgDebugOut.empty()\n515:   Actual: true\n515: Expected: false\n515: tools/gz_TEST.cc:340: Failure\n515: Value of: msg.DebugString()\n515:   Actual: &quot;sdf: \\&quot;<span class=\"cp\">&lt;?xml version=\\\\&#39;1.0\\\\&#39;?&gt;</span>\\\\n<span class=\"nt\">&lt;sdf</span> <span class=\"na\">version=</span><span class=\"s\">\\\\&#39;1.6\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n  <span class=\"nt\">&lt;model</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;my_box\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n    <span class=\"nt\">&lt;pose</span> <span class=\"na\">frame=</span><span class=\"s\">\\\\&#39;\\\\&#39;</span><span class=\"nt\">&gt;</span>0 0 0.5 0 -0 0<span class=\"nt\">&lt;/pose&gt;</span>\\\\n    <span class=\"nt\">&lt;link</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;link\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n      <span class=\"nt\">&lt;collision</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;collision\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n        <span class=\"nt\">&lt;geometry&gt;</span>\\\\n          <span class=\"nt\">&lt;box&gt;</span>\\\\n            <span class=\"nt\">&lt;size&gt;</span>1 1 1<span class=\"nt\">&lt;/size&gt;</span>\\\\n          <span class=\"nt\">&lt;/box&gt;</span>\\\\n        <span class=\"nt\">&lt;/geometry&gt;</span>\\\\n      <span class=\"nt\">&lt;/collision&gt;</span>\\\\n      <span class=\"nt\">&lt;visual</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;visual\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n        <span class=\"nt\">&lt;geometry&gt;</span>\\\\n          <span class=\"nt\">&lt;box&gt;</span>\\\\n            <span class=\"nt\">&lt;size&gt;</span>1 1 1<span class=\"nt\">&lt;/size&gt;</span>\\\\n          <span class=\"nt\">&lt;/box&gt;</span>\\\\n        <span class=\"nt\">&lt;/geometry&gt;</span>\\\\n        <span class=\"nt\">&lt;material&gt;</span>\\\\n          <span class=\"nt\">&lt;script&gt;</span>\\\\n            <span class=\"nt\">&lt;uri&gt;</span>__default__<span class=\"nt\">&lt;/uri&gt;</span>\\\\n            <span class=\"nt\">&lt;name&gt;</span>__default__<span class=\"nt\">&lt;/name&gt;</span>\\\\n          <span class=\"nt\">&lt;/script&gt;</span>\\\\n        <span class=\"nt\">&lt;/material&gt;</span>\\\\n      <span class=\"nt\">&lt;/visual&gt;</span>\\\\n    <span class=\"nt\">&lt;/link&gt;</span>\\\\n  <span class=\"nt\">&lt;/model&gt;</span>\\\\n<span class=\"nt\">&lt;/sdf&gt;</span>\\\\n\\&quot;\\npose {\\n  position {\\n    x: 0\\n    y: 0\\n    z: 0\\n  }\\n  orientation {\\n    x: 0\\n    y: 0\\n    z: 0\\n    w: 1\\n  }\\n}\\n&quot;\n515: Expected: g_msgDebugOut\n515: Which is: &quot;&quot;\n515: tools/gz_TEST.cc:389: Failure\n515: Value of: g_msgDebugOut.empty()\n515:   Actual: true\n515: Expected: false\n515: tools/gz_TEST.cc:404: Failure\n515: Value of: msg.DebugString()\n515:   Actual: &quot;sdf: \\&quot;<span class=\"cp\">&lt;?xml version=\\\\&#39;1.0\\\\&#39;?&gt;</span>\\\\n<span class=\"nt\">&lt;sdf</span> <span class=\"na\">version=</span><span class=\"s\">\\\\&#39;1.6\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n  <span class=\"nt\">&lt;model</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;my_box\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n    <span class=\"nt\">&lt;pose</span> <span class=\"na\">frame=</span><span class=\"s\">\\\\&#39;\\\\&#39;</span><span class=\"nt\">&gt;</span>0 0 0.5 0 -0 0<span class=\"nt\">&lt;/pose&gt;</span>\\\\n    <span class=\"nt\">&lt;link</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;link\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n      <span class=\"nt\">&lt;collision</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;collision\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n        <span class=\"nt\">&lt;geometry&gt;</span>\\\\n          <span class=\"nt\">&lt;box&gt;</span>\\\\n            <span class=\"nt\">&lt;size&gt;</span>1 1 1<span class=\"nt\">&lt;/size&gt;</span>\\\\n          <span class=\"nt\">&lt;/box&gt;</span>\\\\n        <span class=\"nt\">&lt;/geometry&gt;</span>\\\\n      <span class=\"nt\">&lt;/collision&gt;</span>\\\\n      <span class=\"nt\">&lt;visual</span> <span class=\"na\">name=</span><span class=\"s\">\\\\&#39;visual\\\\&#39;</span><span class=\"nt\">&gt;</span>\\\\n        <span class=\"nt\">&lt;geometry&gt;</span>\\\\n          <span class=\"nt\">&lt;box&gt;</span>\\\\n            <span class=\"nt\">&lt;size&gt;</span>1 1 1<span class=\"nt\">&lt;/size&gt;</span>\\\\n          <span class=\"nt\">&lt;/box&gt;</span>\\\\n        <span class=\"nt\">&lt;/geometry&gt;</span>\\\\n        <span class=\"nt\">&lt;material&gt;</span>\\\\n          <span class=\"nt\">&lt;script&gt;</span>\\\\n            <span class=\"nt\">&lt;uri&gt;</span>__default__<span class=\"nt\">&lt;/uri&gt;</span>\\\\n            <span class=\"nt\">&lt;name&gt;</span>__default__<span class=\"nt\">&lt;/name&gt;</span>\\\\n          <span class=\"nt\">&lt;/script&gt;</span>\\\\n        <span class=\"nt\">&lt;/material&gt;</span>\\\\n      <span class=\"nt\">&lt;/visual&gt;</span>\\\\n    <span class=\"nt\">&lt;/link&gt;</span>\\\\n  <span class=\"nt\">&lt;/model&gt;</span>\\\\n<span class=\"nt\">&lt;/sdf&gt;</span>\\\\n\\&quot;\\npose {\\n  position {\\n    x: 0\\n    y: 0\\n    z: 0\\n  }\\n  orientation {\\n    x: 0\\n    y: 0\\n    z: 0\\n    w: 1\\n  }\\n}\\n&quot;\n515: Expected: g_msgDebugOut\n515: Which is: &quot;&quot;\n515: [  FAILED  ] gzTest.Model (7623 ms)\n</pre></div>\n\n\n<p>Ignoring the failed expectation at line 462, since that is fixed in the <code>gz_test_race</code> branch, there are failure at lines 325/340 twice and 389/404 once. Each of these expectations involves invoking <code>gz model</code> to spawn a <code>my_box</code> model and waiting for a subscriber to <code>~/factory</code> to receive the message. These expectations usually pass on my Ubuntu machine, but usually fail on homebrew. The strange thing is that there are other expectations that get model info and pass, so the model must exist. It seems that the only thing failing is the receipt of the <code>~/factory</code> by the gtest executable.</p>", "type": "rendered"}, "assignee": null, "state": "new", "version": null, "edited_on": null, "created_on": "2016-10-12T01:10:26.422719+00:00", "milestone": null, "updated_on": "2016-10-12T01:10:26.422719+00:00", "type": "issue", "id": 2069}