{"links": {"self": {"href": "data/repositories/osrf/gazebo/issues/1013/comments/9288180.json"}, "html": {"href": "#!/osrf/gazebo/issues/1013#comment-9288180"}}, "issue": {"links": {"self": {"href": "data/repositories/osrf/gazebo/issues/1013.json"}}, "type": "issue", "id": 1013, "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "title": "Gripper test sometimes fails (transport/msgs related)"}, "content": {"raw": "Following your investigations, I would say that there is potential risk of generating a segfault on the this->contacts vector. The ```Gripper::OnUpdate()``` can run a clear on the vector while the function ```Gripper::OnContacts``` is doing a push_back. \n\nI've added a mutex to control this actions in  ca173e4.\n\nThe good news: I've built a special branch of release-tool to run 100 times the Gripper test. The results are somewhat promising:\n\n* The [jenkins runs](http://build.osrfoundation.org/job/gazebo-debug_gripper-tmp-precise-amd64/) without the patch, failed all the tries: in 9th run for job 5, in the 28th run for job 6, in the 2sd run for job 7.\n* The [jenkins runs on nvidia display](http://build.osrfoundation.org/job/gazebo-debug_gripper_mutex-tmp-precise-amd64-gpu-nvidia/) **with the patch**, all run passed, this means 600 times successfully.\n\nThe not so good news: while running some [jenkins job patched without DISPLAY](http://build.osrfoundation.org/job/gazebo-debug_gripper_mutex-tmp-precise-amd64/) and in parallel (more than one jenkins job at a time) I've seen some [of them](http://build.osrfoundation.org/job/gazebo-debug_gripper_mutex-tmp-precise-amd64/12/console) hanging. \n\nIt looks like the pattern was:\n```\n[ RUN      ] GripperTest.Close\n\u001b[1;32m[Msg] \u001b[0m\u001b[1;32mWaiting for master.\u001b[0m\u001b[1;32m\n\u001b[0m\u001b[1;32m\u001b[0m\u001b[1;32m[Msg] \u001b[0m\u001b[1;32mConnected to gazebo master @ \u001b[0m\u001b[1;32mhttp://127.0.0.1:11345\u001b[0m\u001b[1;32m\n\u001b[0m\u001b[1;32m\u001b[0m\u001b[1;32m[Msg] \u001b[0m\u001b[1;32mPublicized address: \u001b[0m\u001b[1;32m192.168.1.196\u001b[0m\u001b[1;32m\n\u001b[0m\u001b[1;32m\u001b[0m\u001b[1;31m[Err] \u001b[0m\u001b[1;31m[\u001b[0m\u001b[1;31mRenderEngine.cc\u001b[0m\u001b[1;31m:\u001b[0m\u001b[1;31m665\u001b[0m\u001b[1;31m] \u001b[0m\u001b[1;31mCan't open display: \u001b[0m\u001b[1;31m\u001b[0m\u001b[1;31m\n\u001b[0m\u001b[1;33m[Wrn] \u001b[0m\u001b[1;33m[\u001b[0m\u001b[1;33mRenderEngine.cc\u001b[0m\u001b[1;33m:\u001b[0m\u001b[1;33m88\u001b[0m\u001b[1;33m] \u001b[0m\u001b[1;33mUnable to create X window. Rendering will be disabled\nUnable to create X window. Rendering will be disabled\n... hang ....\n```\nThey were not displayed the message of ```ServerFixture load in ...``` so I'm not sure if there is a potential bug in the mutex or the error is elsewhere.", "markup": "markdown", "html": "<p>Following your investigations, I would say that there is potential risk of generating a segfault on the this-&gt;contacts vector. The <code>Gripper::OnUpdate()</code> can run a clear on the vector while the function <code>Gripper::OnContacts</code> is doing a push_back. </p>\n<p>I've added a mutex to control this actions in  <a href=\"#!/osrf/gazebo/commits/ca173e4\" rel=\"nofollow\" class=\"ap-connect-link\">ca173e4</a>.</p>\n<p>The good news: I've built a special branch of release-tool to run 100 times the Gripper test. The results are somewhat promising:</p>\n<ul>\n<li>The <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-debug_gripper-tmp-precise-amd64/\" rel=\"nofollow\">jenkins runs</a> without the patch, failed all the tries: in 9th run for job 5, in the 28th run for job 6, in the 2sd run for job 7.</li>\n<li>The <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-debug_gripper_mutex-tmp-precise-amd64-gpu-nvidia/\" rel=\"nofollow\">jenkins runs on nvidia display</a> <strong>with the patch</strong>, all run passed, this means 600 times successfully.</li>\n</ul>\n<p>The not so good news: while running some <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-debug_gripper_mutex-tmp-precise-amd64/\" rel=\"nofollow\">jenkins job patched without DISPLAY</a> and in parallel (more than one jenkins job at a time) I've seen some <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-debug_gripper_mutex-tmp-precise-amd64/12/console\" rel=\"nofollow\">of them</a> hanging. </p>\n<p>It looks like the pattern was:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"cp\">[</span> <span class=\"nx\">RUN</span>      <span class=\"cp\">]</span> <span class=\"nt\">GripperTest</span><span class=\"p\">.</span><span class=\"nc\">Close</span>\n<span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">[</span><span class=\"nx\">Msg</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mWaiting</span> <span class=\"nx\">for</span> <span class=\"nx\">master.</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span>\n<span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">[</span><span class=\"nx\">Msg</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mConnected</span> <span class=\"k\">to</span> <span class=\"nx\">gazebo</span> <span class=\"nx\">master</span> <span class=\"p\">@</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mhttp</span><span class=\"p\">:</span><span class=\"c1\">//127.0.0.1:11345\u001b[0m\u001b[1;32m</span>\n<span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">[</span><span class=\"nx\">Msg</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mPublicized</span> <span class=\"nx\">address</span><span class=\"p\">:</span> <span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m192.168.1.196</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span>\n<span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">31</span><span class=\"nx\">m</span><span class=\"err\">[</span><span class=\"nx\">Err</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">31</span><span class=\"nx\">m</span><span class=\"err\">[\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">31</span><span class=\"nx\">mRenderEngine.cc</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">31</span><span class=\"nx\">m</span><span class=\"p\">:</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">31</span><span class=\"nx\">m665</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">31</span><span class=\"nx\">m</span><span class=\"cp\">]</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">31</span><span class=\"nx\">mCan</span><span class=\"s1\">&#39;t open display: \u001b[0m\u001b[1;31m\u001b[0m\u001b[1;31m</span>\n<span class=\"s1\">\u001b[0m\u001b[1;33m[Wrn] \u001b[0m\u001b[1;33m[\u001b[0m\u001b[1;33mRenderEngine.cc\u001b[0m\u001b[1;33m:\u001b[0m\u001b[1;33m88\u001b[0m\u001b[1;33m] \u001b[0m\u001b[1;33mUnable to create X window. Rendering will be disabled</span>\n<span class=\"s1\">Unable to create X window. Rendering will be disabled</span>\n<span class=\"s1\">... hang ....</span>\n</pre></div>\n\n\n<p>They were not displayed the message of <code>ServerFixture load in ...</code> so I'm not sure if there is a potential bug in the mutex or the error is elsewhere.</p>", "type": "rendered"}, "created_on": "2014-03-24T15:22:15.231786+00:00", "user": {"display_name": "Jose Luis Rivero", "uuid": "{d12309b2-f745-42ee-b119-aec4fcdf81fe}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bd12309b2-f745-42ee-b119-aec4fcdf81fe%7D"}, "html": {"href": "https://bitbucket.org/%7Bd12309b2-f745-42ee-b119-aec4fcdf81fe%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/109284c8b83411dbc7492138f6167e9ed=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsJR-5.png"}}, "nickname": "Jose Luis Rivero", "type": "user", "account_id": "557058:155a32e2-420c-4d50-98e0-0e722f63f906"}, "updated_on": null, "type": "issue_comment", "id": 9288180}