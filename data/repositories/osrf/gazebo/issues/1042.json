{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "links": {"attachments": {"href": "data/repositories/osrf/gazebo/issues/1042/attachments_page=1.json"}, "self": {"href": "data/repositories/osrf/gazebo/issues/1042.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/issues/1042/watch"}, "comments": {"href": "data/repositories/osrf/gazebo/issues/1042/comments_page=1.json"}, "html": {"href": "#!/osrf/gazebo/issues/1042/integration_world-test-failure-on-default"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/issues/1042/vote"}}, "reporter": {"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}, "title": "INTEGRATION_world test failure on default", "component": {"name": "testing", "links": {"self": {"href": "data/repositories/osrf/gazebo/components/128164.json"}}}, "votes": 0, "watches": 4, "content": {"raw": "Same test as #945 though the failure is slightly different. Instead of seg-faulting, there is an exception thrown during transport teardown. This test started failing after the new gazebo api was merged to default (pull request #929). See also the [Jenkins results](http://build.osrfoundation.org/job/gazebo-default-devel-quantal-amd64-gpu-nvidia/lastCompletedBuild/testReport/%28root%29/WorldTest/Clear/).\r\n\r\n~~~\r\n[ RUN      ] WorldTest.Clear\r\n[Msg] Waiting for master.\r\n[Msg] Connected to gazebo master @ http://127.0.0.1:11345\r\n[Msg] Publicized address: 192.168.1.188\r\n[Dbg] [ServerFixture.cc:146] ServerFixture load in 1 seconds, timeout after 600 seconds\r\n[Dbg] [ServerFixture.cc:97] ServerFixture::Unload\r\n/home/scpeters/ws/gazebo_sdformat/src/gazebo/test/ServerFixture.cc:237: Failure\r\nExpected: this->server->Fini() doesn't throw an exception.\r\n  Actual: it throws.\r\n[  FAILED  ] WorldTest.Clear (2337 ms)\r\n~~~\r\n\r\nTo get a backtrace, I removed the `ASSERT_NO_THROW` from [ServerFixture.cc:237](#!/osrf/gazebo/src/f40c9cbcb519af7251628d665df44f844cab9e01/test/ServerFixture.cc?at=default#cl-237) and re-ran the test and found that a boost::lock_error was being thrown at [Node.cc:143](#!/osrf/gazebo/src/f40c9cbcb519af7251628d665df44f844cab9e01/gazebo/transport/Node.cc?at=default#cl-143), when `Node::ProcessPublishers()` attempts to lock the publisherDeleteMutex after transport::fini has been called.\r\n~~~\r\n(gdb) thread apply all bt\r\n\r\nThread 2 (Thread 0x7fcb8f239840 (LWP 19195)):\r\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:162\r\n#1  0x00007fcba94b1283 in boost::thread::join() () from /usr/lib/libboost_thread.so.1.49.0\r\n#2  0x0000000000476a87 in ServerFixture::Unload (this=0xd653d0) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/ServerFixture.cc:108\r\n#3  0x000000000047566a in HandleSehExceptionsInMethodIfSupported<testing::Test, void> (method=<optimized out>, object=<optimized out>, location=<optimized out>)\r\n    at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2079\r\n#4  testing::internal::HandleExceptionsInMethodIfSupported<testing::Test, void> (object=object@entry=0xd653d0, method=&virtual testing::Test::TearDown(), \r\n    location=location@entry=0x4a6dfe \"TearDown()\") at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2115\r\n#5  0x0000000000467061 in testing::Test::Run (this=this@entry=0xd653d0) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2160\r\n#6  0x0000000000467187 in testing::TestInfo::Run (this=0xd63550) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2327\r\n#7  0x00000000004672c5 in testing::TestCase::Run (this=0xd63400) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2445\r\n#8  0x0000000000467635 in RunAllTests (this=0xd63090) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:4316\r\n#9  testing::internal::UnitTestImpl::RunAllTests (this=0xd63090) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:4223\r\n#10 0x00000000004751ea in HandleSehExceptionsInMethodIfSupported<testing::internal::UnitTestImpl, bool> (method=<optimized out>, object=<optimized out>, \r\n    location=<optimized out>) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2079\r\n#11 testing::internal::HandleExceptionsInMethodIfSupported<testing::internal::UnitTestImpl, bool> (object=0xd63090, method=\r\n    (bool (testing::internal::UnitTestImpl::*)(testing::internal::UnitTestImpl * const)) 0x467340 <testing::internal::UnitTestImpl::RunAllTests()>, \r\n    location=location@entry=0x4a7e80 \"auxiliary test code (environments or event listeners)\") at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2115\r\n#12 0x00000000004667cd in testing::UnitTest::Run (this=0x6d22c0 <testing::UnitTest::GetInstance()::instance>)\r\n    at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:3930\r\n#13 0x000000000044fe4f in RUN_ALL_TESTS () at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/include/gtest/gtest.h:2288\r\n#14 main (argc=1, argv=<optimized out>) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/integration/world.cc:70\r\n\r\nThread 1 (Thread 0x7fcb8e300700 (LWP 19224)):\r\n#0  0x00007fcba8272425 in __GI_raise (sig=<optimized out>) at ../nptl/sysdeps/unix/sysv/linux/raise.c:64\r\n#1  0x00007fcba8275b8b in __GI_abort () at abort.c:91\r\n#2  0x00007fcba8b6ee2d in __gnu_cxx::__verbose_terminate_handler() () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\r\n#3  0x00007fcba8b6cf26 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\r\n#4  0x00007fcba8b6cf53 in std::terminate() () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\r\n#5  0x00007fcba8b6d17e in __cxa_throw () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\r\n#6  0x00000000004842cd in boost::throw_exception<boost::lock_error> (e=...) at /usr/include/boost/throw_exception.hpp:61\r\n#7  0x0000000000484352 in boost::mutex::lock (this=0x7fcb101e7a00) at /usr/include/boost/thread/pthread/mutex.hpp:63\r\n#8  0x00007fcbaa3ce857 in lock (this=0x7fcb8e2ffb80) at /usr/include/boost/thread/locks.hpp:412\r\n#9  unique_lock (m_=..., this=0x7fcb8e2ffb80) at /usr/include/boost/thread/locks.hpp:290\r\n#10 gazebo::transport::Node::ProcessPublishers (this=0x7fcb101e7900) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/transport/Node.cc:143\r\n#11 0x00007fcbaa3da873 in gazebo::transport::TopicManager::ProcessNodes (this=this@entry=0x6d2580, _onlyOut=_onlyOut@entry=true)\r\n    at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/transport/TopicManager.cc:155\r\n#12 0x00007fcbaa3daf70 in gazebo::transport::TopicManager::Fini (this=0x6d2580) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/transport/TopicManager.cc:76\r\n#13 0x00007fcbaa3de6a1 in gazebo::transport::fini () at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/transport/TransportIface.cc:132\r\n#14 0x000000000049c280 in gazebo::shutdown () at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/gazebo.cc:243\r\n#15 0x00000000004779a5 in ServerFixture::RunServer (this=0xd653d0, _worldFilename=..., _paused=<optimized out>, _physics=...)\r\n    at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/ServerFixture.cc:238\r\n#16 0x00007fcba94b06c9 in ?? () from /usr/lib/libboost_thread.so.1.49.0\r\n#17 0x00007fcbaa120e9a in start_thread (arg=0x7fcb8e300700) at pthread_create.c:308\r\n#18 0x00007fcba83303fd in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:112\r\n#19 0x0000000000000000 in ?? ()\r\n(gdb) \r\n~~~", "markup": "markdown", "html": "<p>Same test as <a href=\"#!/osrf/gazebo/issues/945/integration_world-test-failure-on\" rel=\"nofollow\" title=\"INTEGRATION_world test failure on gazebo_2.1 branch\" class=\"ap-connect-link\"><s>#945</s></a> though the failure is slightly different. Instead of seg-faulting, there is an exception thrown during transport teardown. This test started failing after the new gazebo api was merged to default (<a href=\"#!/osrf/gazebo/pull-requests/929/simplify-the-process-of-using-gazebo-as-a\" rel=\"nofollow\" class=\"ap-connect-link\">pull request #929</a>). See also the <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-default-devel-quantal-amd64-gpu-nvidia/lastCompletedBuild/testReport/%28root%29/WorldTest/Clear/\" rel=\"nofollow\">Jenkins results</a>.</p>\n<div class=\"codehilite\"><pre><span></span>[ RUN      ] WorldTest.Clear\n[Msg] Waiting for master.\n[Msg] Connected to gazebo master @ http://127.0.0.1:11345\n[Msg] Publicized address: 192.168.1.188\n[Dbg] [ServerFixture.cc:146] ServerFixture load in 1 seconds, timeout after 600 seconds\n[Dbg] [ServerFixture.cc:97] ServerFixture::Unload\n/home/scpeters/ws/gazebo_sdformat/src/gazebo/test/ServerFixture.cc:237: Failure\nExpected: this-&gt;server-&gt;Fini() doesn&#39;t throw an exception.\n  Actual: it throws.\n[  FAILED  ] WorldTest.Clear (2337 ms)\n</pre></div>\n\n\n<p>To get a backtrace, I removed the <code>ASSERT_NO_THROW</code> from <a data-is-external-link=\"true\" href=\"#!/osrf/gazebo/src/f40c9cbcb519af7251628d665df44f844cab9e01/test/ServerFixture.cc?at=default#cl-237\" rel=\"nofollow\">ServerFixture.cc:237</a> and re-ran the test and found that a boost::lock_error was being thrown at <a data-is-external-link=\"true\" href=\"#!/osrf/gazebo/src/f40c9cbcb519af7251628d665df44f844cab9e01/gazebo/transport/Node.cc?at=default#cl-143\" rel=\"nofollow\">Node.cc:143</a>, when <code>Node::ProcessPublishers()</code> attempts to lock the publisherDeleteMutex after transport::fini has been called.</p>\n<div class=\"codehilite\"><pre><span></span>(gdb) thread apply all bt\n\nThread 2 (Thread 0x7fcb8f239840 (LWP 19195)):\n#0  pthread_cond_wait@@GLIBC_2.3.2 () at ../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:162\n#1  0x00007fcba94b1283 in boost::thread::join() () from /usr/lib/libboost_thread.so.1.49.0\n#2  0x0000000000476a87 in ServerFixture::Unload (this=0xd653d0) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/ServerFixture.cc:108\n#3  0x000000000047566a in HandleSehExceptionsInMethodIfSupported&lt;testing::Test, void&gt; (method=&lt;optimized out&gt;, object=&lt;optimized out&gt;, location=&lt;optimized out&gt;)\n    at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2079\n#4  testing::internal::HandleExceptionsInMethodIfSupported&lt;testing::Test, void&gt; (object=object@entry=0xd653d0, method=&amp;virtual testing::Test::TearDown(), \n    location=location@entry=0x4a6dfe &quot;TearDown()&quot;) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2115\n#5  0x0000000000467061 in testing::Test::Run (this=this@entry=0xd653d0) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2160\n#6  0x0000000000467187 in testing::TestInfo::Run (this=0xd63550) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2327\n#7  0x00000000004672c5 in testing::TestCase::Run (this=0xd63400) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2445\n#8  0x0000000000467635 in RunAllTests (this=0xd63090) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:4316\n#9  testing::internal::UnitTestImpl::RunAllTests (this=0xd63090) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:4223\n#10 0x00000000004751ea in HandleSehExceptionsInMethodIfSupported&lt;testing::internal::UnitTestImpl, bool&gt; (method=&lt;optimized out&gt;, object=&lt;optimized out&gt;, \n    location=&lt;optimized out&gt;) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2079\n#11 testing::internal::HandleExceptionsInMethodIfSupported&lt;testing::internal::UnitTestImpl, bool&gt; (object=0xd63090, method=\n    (bool (testing::internal::UnitTestImpl::*)(testing::internal::UnitTestImpl * const)) 0x467340 &lt;testing::internal::UnitTestImpl::RunAllTests()&gt;, \n    location=location@entry=0x4a7e80 &quot;auxiliary test code (environments or event listeners)&quot;) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:2115\n#12 0x00000000004667cd in testing::UnitTest::Run (this=0x6d22c0 &lt;testing::UnitTest::GetInstance()::instance&gt;)\n    at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/src/gtest.cc:3930\n#13 0x000000000044fe4f in RUN_ALL_TESTS () at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/gtest/include/gtest/gtest.h:2288\n#14 main (argc=1, argv=&lt;optimized out&gt;) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/integration/world.cc:70\n\nThread 1 (Thread 0x7fcb8e300700 (LWP 19224)):\n#0  0x00007fcba8272425 in __GI_raise (sig=&lt;optimized out&gt;) at ../nptl/sysdeps/unix/sysv/linux/raise.c:64\n#1  0x00007fcba8275b8b in __GI_abort () at abort.c:91\n#2  0x00007fcba8b6ee2d in __gnu_cxx::__verbose_terminate_handler() () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#3  0x00007fcba8b6cf26 in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#4  0x00007fcba8b6cf53 in std::terminate() () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#5  0x00007fcba8b6d17e in __cxa_throw () from /usr/lib/x86_64-linux-gnu/libstdc++.so.6\n#6  0x00000000004842cd in boost::throw_exception&lt;boost::lock_error&gt; (e=...) at /usr/include/boost/throw_exception.hpp:61\n#7  0x0000000000484352 in boost::mutex::lock (this=0x7fcb101e7a00) at /usr/include/boost/thread/pthread/mutex.hpp:63\n#8  0x00007fcbaa3ce857 in lock (this=0x7fcb8e2ffb80) at /usr/include/boost/thread/locks.hpp:412\n#9  unique_lock (m_=..., this=0x7fcb8e2ffb80) at /usr/include/boost/thread/locks.hpp:290\n#10 gazebo::transport::Node::ProcessPublishers (this=0x7fcb101e7900) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/transport/Node.cc:143\n#11 0x00007fcbaa3da873 in gazebo::transport::TopicManager::ProcessNodes (this=this@entry=0x6d2580, _onlyOut=_onlyOut@entry=true)\n    at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/transport/TopicManager.cc:155\n#12 0x00007fcbaa3daf70 in gazebo::transport::TopicManager::Fini (this=0x6d2580) at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/transport/TopicManager.cc:76\n#13 0x00007fcbaa3de6a1 in gazebo::transport::fini () at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/transport/TransportIface.cc:132\n#14 0x000000000049c280 in gazebo::shutdown () at /home/scpeters/ws/gazebo_sdformat/src/gazebo/gazebo/gazebo.cc:243\n#15 0x00000000004779a5 in ServerFixture::RunServer (this=0xd653d0, _worldFilename=..., _paused=&lt;optimized out&gt;, _physics=...)\n    at /home/scpeters/ws/gazebo_sdformat/src/gazebo/test/ServerFixture.cc:238\n#16 0x00007fcba94b06c9 in ?? () from /usr/lib/libboost_thread.so.1.49.0\n#17 0x00007fcbaa120e9a in start_thread (arg=0x7fcb8e300700) at pthread_create.c:308\n#18 0x00007fcba83303fd in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:112\n#19 0x0000000000000000 in ?? ()\n(gdb) \n</pre></div>", "type": "rendered"}, "assignee": null, "state": "closed", "version": {"name": "all", "links": {"self": {"href": "data/repositories/osrf/gazebo/versions/225575.json"}}}, "edited_on": null, "created_on": "2014-02-10T22:24:09.589805+00:00", "milestone": null, "updated_on": "2016-09-14T19:45:31.169683+00:00", "type": "issue", "id": 1042}