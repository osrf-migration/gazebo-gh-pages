{"rendered": {"description": {"raw": "We have noticed in jenkins that `UNIT_gz_TEST` is pretty flaky. It is the most common failure on our homebrew builds, which repeat failing tests once to try to week out flakes. The gazebo7 homebrew build has been failing most often during the [gzTest.Model subtest](http://build.osrfoundation.org/job/gazebo-ci-gazebo7-homebrew-amd64/85/testReport/(root)/gzTest/Model/), but it can also timeout or crash, in which case the [UNIT_gz_TEST.test_ran](http://build.osrfoundation.org/job/gazebo-ci_BTCoverage-default-trusty-amd64-gpu-none/135/testReport/(root)/UNIT_gz_TEST/test_ran/) failure can be seen.\r\n\r\nThis PR reduces the flakiness of the test and disables some troublesome expectations:\r\n\r\n1. Improve initialization by calling `gazebo::client::setup()` instead of `gazebo::transport::init()` and then later `gazebo::transport::run()`. This is the preferred way to write listener programs now. This required linking the test to the `libgazebo_client` library.\r\n\r\n2. Wait for the `~/world_stats` topic to be listed. The `gzTest.Topic` test can fail if the `gzserver` has not finished initializing, so the `transport::getAdvertisedTopics` API is used to wait for that topic. This is helpful for the other tests as well to wait for the gzserver to be ready before proceeding.\r\n\r\n3. Don't start a `gzserver` with the `init()` and `fini()` calls for the SDF test, since it doesn't need it.\r\n\r\n4. When deleting a model, the test currently expects to see an `entity_delete` message on the `~/request` topic with some of the text in the message matching the name of the model to be deleted. This is problematic, however, since `Link::Fini` [publishes entity_delete requests with an integer id of its child visuals](#!/osrf/gazebo/src/31944e8d9da6220d0c90a2fc30b0c1d8c75751b6/gazebo/physics/Link.cc?fileviewer=file-view-default#Link.cc-272), and these messages don't contain the model name, just an integer. There is a [design document](#!/osrf/gazebo_design/pull-requests/31/insertion-and-deletion-flow/diff) about improving model insertion and deletion, so I would like to disable these expectations until that design document is implemented. At that time, it should be easier to write reasonable expectations.\r\n\r\n5. Finally, I observed a problem that `~/factory` messages were being published, and we were later able to get `model_info` about the created model, but the `~/factory` messages were never received by the test, leading to failed expectations. I documented this in #2069 and disabled the expectations.\r\n\r\nThe test should be more reliable now. I have tested it repeatedly on trusty and homebrew and it is passing reliably now. It passed in one [homebrew jenkins build](http://build.osrfoundation.org/job/gazebo-ci-pr_any-homebrew-amd64/693/testReport/(root)/gzTest/) too.\r\n", "markup": "markdown", "html": "<p>We have noticed in jenkins that <code>UNIT_gz_TEST</code> is pretty flaky. It is the most common failure on our homebrew builds, which repeat failing tests once to try to week out flakes. The gazebo7 homebrew build has been failing most often during the <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-ci-gazebo7-homebrew-amd64/85/testReport/(root)/gzTest/Model/\" rel=\"nofollow\">gzTest.Model subtest</a>, but it can also timeout or crash, in which case the <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-ci_BTCoverage-default-trusty-amd64-gpu-none/135/testReport/(root)/UNIT_gz_TEST/test_ran/\" rel=\"nofollow\">UNIT_gz_TEST.test_ran</a> failure can be seen.</p>\n<p>This PR reduces the flakiness of the test and disables some troublesome expectations:</p>\n<ol>\n<li>\n<p>Improve initialization by calling <code>gazebo::client::setup()</code> instead of <code>gazebo::transport::init()</code> and then later <code>gazebo::transport::run()</code>. This is the preferred way to write listener programs now. This required linking the test to the <code>libgazebo_client</code> library.</p>\n</li>\n<li>\n<p>Wait for the <code>~/world_stats</code> topic to be listed. The <code>gzTest.Topic</code> test can fail if the <code>gzserver</code> has not finished initializing, so the <code>transport::getAdvertisedTopics</code> API is used to wait for that topic. This is helpful for the other tests as well to wait for the gzserver to be ready before proceeding.</p>\n</li>\n<li>\n<p>Don't start a <code>gzserver</code> with the <code>init()</code> and <code>fini()</code> calls for the SDF test, since it doesn't need it.</p>\n</li>\n<li>\n<p>When deleting a model, the test currently expects to see an <code>entity_delete</code> message on the <code>~/request</code> topic with some of the text in the message matching the name of the model to be deleted. This is problematic, however, since <code>Link::Fini</code> <a data-is-external-link=\"true\" href=\"#!/osrf/gazebo/src/31944e8d9da6220d0c90a2fc30b0c1d8c75751b6/gazebo/physics/Link.cc?fileviewer=file-view-default#Link.cc-272\" rel=\"nofollow\">publishes entity_delete requests with an integer id of its child visuals</a>, and these messages don't contain the model name, just an integer. There is a <a data-is-external-link=\"true\" href=\"#!/osrf/gazebo_design/pull-requests/31/insertion-and-deletion-flow/diff\" rel=\"nofollow\">design document</a> about improving model insertion and deletion, so I would like to disable these expectations until that design document is implemented. At that time, it should be easier to write reasonable expectations.</p>\n</li>\n<li>\n<p>Finally, I observed a problem that <code>~/factory</code> messages were being published, and we were later able to get <code>model_info</code> about the created model, but the <code>~/factory</code> messages were never received by the test, leading to failed expectations. I documented this in <a href=\"#!/osrf/gazebo/issues/2069/factory-messages-arent-always-received-in\" rel=\"nofollow\" title=\"Factory messages aren&#39;t always received in gzTest.Model\" class=\"ap-connect-link\">#2069</a> and disabled the expectations.</p>\n</li>\n</ol>\n<p>The test should be more reliable now. I have tested it repeatedly on trusty and homebrew and it is passing reliably now. It passed in one <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-ci-pr_any-homebrew-amd64/693/testReport/(root)/gzTest/\" rel=\"nofollow\">homebrew jenkins build</a> too.</p>", "type": "rendered"}, "title": {"raw": "Reduce flakiness of UNIT_gz_TEST", "markup": "markdown", "html": "<p>Reduce flakiness of UNIT_gz_TEST</p>", "type": "rendered"}}, "type": "pullrequest", "description": "We have noticed in jenkins that `UNIT_gz_TEST` is pretty flaky. It is the most common failure on our homebrew builds, which repeat failing tests once to try to week out flakes. The gazebo7 homebrew build has been failing most often during the [gzTest.Model subtest](http://build.osrfoundation.org/job/gazebo-ci-gazebo7-homebrew-amd64/85/testReport/(root)/gzTest/Model/), but it can also timeout or crash, in which case the [UNIT_gz_TEST.test_ran](http://build.osrfoundation.org/job/gazebo-ci_BTCoverage-default-trusty-amd64-gpu-none/135/testReport/(root)/UNIT_gz_TEST/test_ran/) failure can be seen.\r\n\r\nThis PR reduces the flakiness of the test and disables some troublesome expectations:\r\n\r\n1. Improve initialization by calling `gazebo::client::setup()` instead of `gazebo::transport::init()` and then later `gazebo::transport::run()`. This is the preferred way to write listener programs now. This required linking the test to the `libgazebo_client` library.\r\n\r\n2. Wait for the `~/world_stats` topic to be listed. The `gzTest.Topic` test can fail if the `gzserver` has not finished initializing, so the `transport::getAdvertisedTopics` API is used to wait for that topic. This is helpful for the other tests as well to wait for the gzserver to be ready before proceeding.\r\n\r\n3. Don't start a `gzserver` with the `init()` and `fini()` calls for the SDF test, since it doesn't need it.\r\n\r\n4. When deleting a model, the test currently expects to see an `entity_delete` message on the `~/request` topic with some of the text in the message matching the name of the model to be deleted. This is problematic, however, since `Link::Fini` [publishes entity_delete requests with an integer id of its child visuals](#!/osrf/gazebo/src/31944e8d9da6220d0c90a2fc30b0c1d8c75751b6/gazebo/physics/Link.cc?fileviewer=file-view-default#Link.cc-272), and these messages don't contain the model name, just an integer. There is a [design document](#!/osrf/gazebo_design/pull-requests/31/insertion-and-deletion-flow/diff) about improving model insertion and deletion, so I would like to disable these expectations until that design document is implemented. At that time, it should be easier to write reasonable expectations.\r\n\r\n5. Finally, I observed a problem that `~/factory` messages were being published, and we were later able to get `model_info` about the created model, but the `~/factory` messages were never received by the test, leading to failed expectations. I documented this in #2069 and disabled the expectations.\r\n\r\nThe test should be more reliable now. I have tested it repeatedly on trusty and homebrew and it is passing reliably now. It passed in one [homebrew jenkins build](http://build.osrfoundation.org/job/gazebo-ci-pr_any-homebrew-amd64/693/testReport/(root)/gzTest/) too.\r\n", "links": {"decline": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/pullrequests/2471/decline"}, "diffstat": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/diffstat/osrf/gazebo:c90231ae7424%0Df40aa9d40286?from_pullrequest_id=2471"}, "commits": {"href": "data/repositories/osrf/gazebo/pullrequests/2471/commits.json"}, "self": {"href": "data/repositories/osrf/gazebo/pullrequests/2471.json"}, "comments": {"href": "data/repositories/osrf/gazebo/pullrequests/2471/comments_page=1.json"}, "merge": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/pullrequests/2471/merge"}, "html": {"href": "#!/osrf/gazebo/pull-requests/2471"}, "activity": {"href": "data/repositories/osrf/gazebo/pullrequests/2471/activity.json"}, "diff": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/diff/osrf/gazebo:c90231ae7424%0Df40aa9d40286?from_pullrequest_id=2471"}, "approve": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/pullrequests/2471/approve"}, "statuses": {"href": "data/repositories/osrf/gazebo/pullrequests/2471/statuses_page=1.json"}}, "title": "Reduce flakiness of UNIT_gz_TEST", "close_source_branch": true, "reviewers": [], "id": 2471, "destination": {"commit": {"hash": "f40aa9d40286", "type": "commit", "links": {"self": {"href": "data/repositories/osrf/gazebo/commit/f40aa9d40286.json"}, "html": {"href": "#!/osrf/gazebo/commits/f40aa9d40286"}}}, "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "branch": {"name": "gazebo7"}}, "created_on": "2016-10-12T19:03:22.473716+00:00", "summary": {"raw": "We have noticed in jenkins that `UNIT_gz_TEST` is pretty flaky. It is the most common failure on our homebrew builds, which repeat failing tests once to try to week out flakes. The gazebo7 homebrew build has been failing most often during the [gzTest.Model subtest](http://build.osrfoundation.org/job/gazebo-ci-gazebo7-homebrew-amd64/85/testReport/(root)/gzTest/Model/), but it can also timeout or crash, in which case the [UNIT_gz_TEST.test_ran](http://build.osrfoundation.org/job/gazebo-ci_BTCoverage-default-trusty-amd64-gpu-none/135/testReport/(root)/UNIT_gz_TEST/test_ran/) failure can be seen.\r\n\r\nThis PR reduces the flakiness of the test and disables some troublesome expectations:\r\n\r\n1. Improve initialization by calling `gazebo::client::setup()` instead of `gazebo::transport::init()` and then later `gazebo::transport::run()`. This is the preferred way to write listener programs now. This required linking the test to the `libgazebo_client` library.\r\n\r\n2. Wait for the `~/world_stats` topic to be listed. The `gzTest.Topic` test can fail if the `gzserver` has not finished initializing, so the `transport::getAdvertisedTopics` API is used to wait for that topic. This is helpful for the other tests as well to wait for the gzserver to be ready before proceeding.\r\n\r\n3. Don't start a `gzserver` with the `init()` and `fini()` calls for the SDF test, since it doesn't need it.\r\n\r\n4. When deleting a model, the test currently expects to see an `entity_delete` message on the `~/request` topic with some of the text in the message matching the name of the model to be deleted. This is problematic, however, since `Link::Fini` [publishes entity_delete requests with an integer id of its child visuals](#!/osrf/gazebo/src/31944e8d9da6220d0c90a2fc30b0c1d8c75751b6/gazebo/physics/Link.cc?fileviewer=file-view-default#Link.cc-272), and these messages don't contain the model name, just an integer. There is a [design document](#!/osrf/gazebo_design/pull-requests/31/insertion-and-deletion-flow/diff) about improving model insertion and deletion, so I would like to disable these expectations until that design document is implemented. At that time, it should be easier to write reasonable expectations.\r\n\r\n5. Finally, I observed a problem that `~/factory` messages were being published, and we were later able to get `model_info` about the created model, but the `~/factory` messages were never received by the test, leading to failed expectations. I documented this in #2069 and disabled the expectations.\r\n\r\nThe test should be more reliable now. I have tested it repeatedly on trusty and homebrew and it is passing reliably now. It passed in one [homebrew jenkins build](http://build.osrfoundation.org/job/gazebo-ci-pr_any-homebrew-amd64/693/testReport/(root)/gzTest/) too.\r\n", "markup": "markdown", "html": "<p>We have noticed in jenkins that <code>UNIT_gz_TEST</code> is pretty flaky. It is the most common failure on our homebrew builds, which repeat failing tests once to try to week out flakes. The gazebo7 homebrew build has been failing most often during the <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-ci-gazebo7-homebrew-amd64/85/testReport/(root)/gzTest/Model/\" rel=\"nofollow\">gzTest.Model subtest</a>, but it can also timeout or crash, in which case the <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-ci_BTCoverage-default-trusty-amd64-gpu-none/135/testReport/(root)/UNIT_gz_TEST/test_ran/\" rel=\"nofollow\">UNIT_gz_TEST.test_ran</a> failure can be seen.</p>\n<p>This PR reduces the flakiness of the test and disables some troublesome expectations:</p>\n<ol>\n<li>\n<p>Improve initialization by calling <code>gazebo::client::setup()</code> instead of <code>gazebo::transport::init()</code> and then later <code>gazebo::transport::run()</code>. This is the preferred way to write listener programs now. This required linking the test to the <code>libgazebo_client</code> library.</p>\n</li>\n<li>\n<p>Wait for the <code>~/world_stats</code> topic to be listed. The <code>gzTest.Topic</code> test can fail if the <code>gzserver</code> has not finished initializing, so the <code>transport::getAdvertisedTopics</code> API is used to wait for that topic. This is helpful for the other tests as well to wait for the gzserver to be ready before proceeding.</p>\n</li>\n<li>\n<p>Don't start a <code>gzserver</code> with the <code>init()</code> and <code>fini()</code> calls for the SDF test, since it doesn't need it.</p>\n</li>\n<li>\n<p>When deleting a model, the test currently expects to see an <code>entity_delete</code> message on the <code>~/request</code> topic with some of the text in the message matching the name of the model to be deleted. This is problematic, however, since <code>Link::Fini</code> <a data-is-external-link=\"true\" href=\"#!/osrf/gazebo/src/31944e8d9da6220d0c90a2fc30b0c1d8c75751b6/gazebo/physics/Link.cc?fileviewer=file-view-default#Link.cc-272\" rel=\"nofollow\">publishes entity_delete requests with an integer id of its child visuals</a>, and these messages don't contain the model name, just an integer. There is a <a data-is-external-link=\"true\" href=\"#!/osrf/gazebo_design/pull-requests/31/insertion-and-deletion-flow/diff\" rel=\"nofollow\">design document</a> about improving model insertion and deletion, so I would like to disable these expectations until that design document is implemented. At that time, it should be easier to write reasonable expectations.</p>\n</li>\n<li>\n<p>Finally, I observed a problem that <code>~/factory</code> messages were being published, and we were later able to get <code>model_info</code> about the created model, but the <code>~/factory</code> messages were never received by the test, leading to failed expectations. I documented this in <a href=\"#!/osrf/gazebo/issues/2069/factory-messages-arent-always-received-in\" rel=\"nofollow\" title=\"Factory messages aren&#39;t always received in gzTest.Model\" class=\"ap-connect-link\">#2069</a> and disabled the expectations.</p>\n</li>\n</ol>\n<p>The test should be more reliable now. I have tested it repeatedly on trusty and homebrew and it is passing reliably now. It passed in one <a data-is-external-link=\"true\" href=\"http://build.osrfoundation.org/job/gazebo-ci-pr_any-homebrew-amd64/693/testReport/(root)/gzTest/\" rel=\"nofollow\">homebrew jenkins build</a> too.</p>", "type": "rendered"}, "source": {"commit": {"hash": "00900755a50b", "type": "commit", "links": {"self": {"href": "data/repositories/osrf/gazebo/commit/00900755a50b.json"}, "html": {"href": "#!/osrf/gazebo/commits/00900755a50b"}}}, "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "branch": {"name": "gz_test_race"}}, "comment_count": 5, "state": "MERGED", "task_count": 0, "participants": [{"role": "PARTICIPANT", "participated_on": "2016-10-13T18:29:26.650154+00:00", "type": "participant", "approved": false, "user": {"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}}, {"role": "PARTICIPANT", "participated_on": "2016-10-13T20:30:34.766802+00:00", "type": "participant", "approved": true, "user": {"display_name": "Carlos Ag\u00fcero", "uuid": "{da8a8e89-4bb0-421b-bd0e-dbbed3d4ed6a}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bda8a8e89-4bb0-421b-bd0e-dbbed3d4ed6a%7D"}, "html": {"href": "https://bitbucket.org/%7Bda8a8e89-4bb0-421b-bd0e-dbbed3d4ed6a%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/692bf15758111acaddae4da15a47f9e5d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsCA-0.png"}}, "nickname": "caguero", "type": "user", "account_id": "557058:4ded1ddf-947e-4154-bbd1-3dba24f1bdbd"}}, {"role": "PARTICIPANT", "participated_on": "2016-10-13T20:33:48.235536+00:00", "type": "participant", "approved": true, "user": {"display_name": "Nate Koenig", "uuid": "{c862cdd9-fcc8-4419-9fc7-e20db14b8fcb}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bc862cdd9-fcc8-4419-9fc7-e20db14b8fcb%7D"}, "html": {"href": "https://bitbucket.org/%7Bc862cdd9-fcc8-4419-9fc7-e20db14b8fcb%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:095b1e12-74ed-4e20-b44f-2f0745b616e0/ca24bb11-4787-4b14-a20d-d91835e9bde2/128"}}, "nickname": "Nathan Koenig", "type": "user", "account_id": "557058:095b1e12-74ed-4e20-b44f-2f0745b616e0"}}], "reason": "", "updated_on": "2016-10-13T21:25:10.710455+00:00", "author": {"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}, "merge_commit": {"hash": "c90231ae7424", "type": "commit", "links": {"self": {"href": "data/repositories/osrf/gazebo/commit/c90231ae7424.json"}, "html": {"href": "#!/osrf/gazebo/commits/c90231ae7424"}}}, "closed_by": {"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}}