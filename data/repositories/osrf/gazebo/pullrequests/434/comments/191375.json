{"links": {"self": {"href": "data/repositories/osrf/gazebo/pullrequests/434/comments/191375.json"}, "html": {"href": "#!/osrf/gazebo/pull-requests/434/_/diff#comment-191375"}}, "deleted": false, "pullrequest": {"type": "pullrequest", "id": 434, "links": {"self": {"href": "data/repositories/osrf/gazebo/pullrequests/434.json"}, "html": {"href": "#!/osrf/gazebo/pull-requests/434"}}, "title": "Allow world with a name other than \"default\". Fixed all tests."}, "content": {"raw": "I just tested this branch on Jenkins with the gazebo-any job. There are two test failures: TransportStressTest.ManyNodes and NonDefaultWorld.Load. http://build.osrfoundation.org/job/gazebo-any-devel-precise-amd64/59/\n\nHere's the raw console output for TransportStressTest.ManyNodes:\n~~~\n101: [ RUN      ] TransportStressTest.ManyNodes\n101: Gazebo multi-robot simulator, version 1.6.1\n101: Copyright (C) 2013 Open Source Robotics Foundation.\n101: Released under the Apache 2 License.\n101: http://gazebosim.org\n...\n101: \u001b[1;32mMsg\u001b[0m Waiting for master\u001b[1;32mMsg\u001b[0m Connected to gazebo master @ http://127.0.0.1:11345\n101: \u001b[1;32mMsg\u001b[0m Publicized address: 192.168.1.71\n101: \u001b[1;31mError [RenderEngine.cc:608]\u001b[0m Can't open display: \n101: \u001b[1;33mWarning [RenderEngine.cc:87]\u001b[0m Unable to create X window. Rendering will be disabled\n101: \u001b[1;36mDbg\u001b[0m ServerFixture load in 0.16 seconds, timeout after 60 seconds\n101: \u001b[1;32mMsg\u001b[0m Publish complete\n101: \u001b[1;33mWarning [Publisher.cc:127]\u001b[0m Queue limit reached for topic /gazebo/default/diagnostics, deleting message. This warning is printed only once.\n101: \u001b[1;33mWarning [Publisher.cc:127]\u001b[0m Queue limit reached for topic /gazebo/default/physics/contacts, deleting message. This warning is printed only once.\n101: /var/lib/jenkins/workspace/gazebo-any-devel-precise-amd64/gazebo/test/regression/transport_stress.cc:196: Failure\n101: Expected: (waitCount) < (50), actual: 50 vs 50\n101: /var/lib/jenkins/workspace/gazebo-any-devel-precise-amd64/gazebo/test/regression/transport_stress.cc:199: Failure\n101: Value of: g_localPublishCount\n101:   Actual: 3362832\n101: Expected: g_totalExpectedMsgCount\n101: Which is: 40000000\n101: \u001b[1;32mMsg\u001b[0m Time to publish 20000 = 0 23202196\n101: \u001b[1;32mMsg\u001b[0m Time to receive 3364223 = -8 -600090337\n101: [  FAILED  ] TransportStressTest.ManyNodes (78543 ms)\n~~~\n\nThe NonDefaultWorld.Load appears to fail when run on a machine with no display (I test this by ssh'ing to my own machine). The test loads much more quickly and fails before pose messages can be received by ServerFixture for the HasEntity call. Here's a patch that fixes the test for me without a display:\n~~~\ndiff -r 237e08ff175c test/regression/nondefault_world.cc\n--- a/test/regression/nondefault_world.cc\tTue Apr 09 16:18:31 2013 -0700\n+++ b/test/regression/nondefault_world.cc\tTue Apr 09 18:00:33 2013 -0700\n@@ -26,20 +26,12 @@\n TEST_F(NonDefaultWorld, Load)\n {\n   math::Pose setPose, testPose;\n-  Load(\"worlds/empty_different_name.world\");\n-  SetPause(false);\n+  Load(\"worlds/empty_different_name.world\", true);\n+  physics::WorldPtr world = physics::get_world(\"not_the_default_world_name\");\n+  ASSERT_TRUE(world != NULL);\n \n-  int i = 0;\n-\n-  // Wait for the entity to spawn\n-  while (!HasEntity(\"ground_plane\") && i < 10)\n-  {\n-    common::Time::MSleep(100);\n-    ++i;\n-  }\n-\n-  EXPECT_TRUE(HasEntity(\"ground_plane\"));\n-  EXPECT_LT(i, 10);\n+  physics::ModelPtr model = world->GetModel(\"ground_plane\");\n+  ASSERT_TRUE(model);\n }\n \n int main(int argc, char **argv)\n~~~", "markup": "markdown", "html": "<p>I just tested this branch on Jenkins with the gazebo-any job. There are two test failures: TransportStressTest.ManyNodes and NonDefaultWorld.Load. <a href=\"http://build.osrfoundation.org/job/gazebo-any-devel-precise-amd64/59/\" rel=\"nofollow\" class=\"ap-connect-link\">http://build.osrfoundation.org/job/gazebo-any-devel-precise-amd64/59/</a></p>\n<p>Here's the raw console output for TransportStressTest.ManyNodes:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"nt\">101</span><span class=\"o\">:</span> <span class=\"cp\">[</span> <span class=\"nx\">RUN</span>      <span class=\"cp\">]</span> <span class=\"nt\">TransportStressTest</span><span class=\"p\">.</span><span class=\"nc\">ManyNodes</span>\n<span class=\"nt\">101</span><span class=\"o\">:</span> <span class=\"nt\">Gazebo</span> <span class=\"nt\">multi-robot</span> <span class=\"nt\">simulator</span><span class=\"o\">,</span> <span class=\"nt\">version</span> <span class=\"nt\">1</span><span class=\"p\">.</span><span class=\"nc\">6</span><span class=\"p\">.</span><span class=\"nc\">1</span>\n<span class=\"nt\">101</span><span class=\"o\">:</span> <span class=\"nt\">Copyright</span> <span class=\"o\">(</span><span class=\"nt\">C</span><span class=\"o\">)</span> <span class=\"nt\">2013</span> <span class=\"nt\">Open</span> <span class=\"nt\">Source</span> <span class=\"nt\">Robotics</span> <span class=\"nt\">Foundation</span><span class=\"o\">.</span>\n<span class=\"nt\">101</span><span class=\"o\">:</span> <span class=\"nt\">Released</span> <span class=\"nt\">under</span> <span class=\"nt\">the</span> <span class=\"nt\">Apache</span> <span class=\"nt\">2</span> <span class=\"nt\">License</span><span class=\"o\">.</span>\n<span class=\"nt\">101</span><span class=\"o\">:</span> <span class=\"nt\">http</span><span class=\"o\">://</span><span class=\"nt\">gazebosim</span><span class=\"p\">.</span><span class=\"nc\">org</span>\n<span class=\"o\">...</span>\n<span class=\"nt\">101</span><span class=\"o\">:</span> <span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mMsg</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span> <span class=\"nx\">Waiting</span> <span class=\"nx\">for</span> <span class=\"nx\">master</span><span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mMsg</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span> <span class=\"nx\">Connected</span> <span class=\"k\">to</span> <span class=\"nx\">gazebo</span> <span class=\"nx\">master</span> <span class=\"p\">@</span> <span class=\"nx\">http</span><span class=\"p\">:</span><span class=\"c1\">//127.0.0.1:11345</span>\n<span class=\"mi\">101</span><span class=\"p\">:</span> <span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">32</span><span class=\"nx\">mMsg</span><span class=\"err\">\u001b[</span><span class=\"mi\">0</span><span class=\"nx\">m</span> <span class=\"nx\">Publicized</span> <span class=\"nx\">address</span><span class=\"p\">:</span> <span class=\"mf\">192.168.1.71</span>\n<span class=\"mi\">101</span><span class=\"p\">:</span> <span class=\"err\">\u001b[</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"mi\">31</span><span class=\"nx\">mError</span> <span class=\"err\">[</span><span class=\"nx\">RenderEngine.cc</span><span class=\"p\">:</span><span class=\"mi\">608</span><span class=\"cp\">]</span><span class=\"err\">\u001b</span><span class=\"cp\">[</span><span class=\"mi\">0</span><span class=\"nx\">m</span> <span class=\"nx\">Can</span><span class=\"s1\">&#39;t open display: </span>\n<span class=\"s1\">101: \u001b[1;33mWarning [RenderEngine.cc:87]\u001b[0m Unable to create X window. Rendering will be disabled</span>\n<span class=\"s1\">101: \u001b[1;36mDbg\u001b[0m ServerFixture load in 0.16 seconds, timeout after 60 seconds</span>\n<span class=\"s1\">101: \u001b[1;32mMsg\u001b[0m Publish complete</span>\n<span class=\"s1\">101: \u001b[1;33mWarning [Publisher.cc:127]\u001b[0m Queue limit reached for topic /gazebo/default/diagnostics, deleting message. This warning is printed only once.</span>\n<span class=\"s1\">101: \u001b[1;33mWarning [Publisher.cc:127]\u001b[0m Queue limit reached for topic /gazebo/default/physics/contacts, deleting message. This warning is printed only once.</span>\n<span class=\"s1\">101: /var/lib/jenkins/workspace/gazebo-any-devel-precise-amd64/gazebo/test/regression/transport_stress.cc:196: Failure</span>\n<span class=\"s1\">101: Expected: (waitCount) &lt; (50), actual: 50 vs 50</span>\n<span class=\"s1\">101: /var/lib/jenkins/workspace/gazebo-any-devel-precise-amd64/gazebo/test/regression/transport_stress.cc:199: Failure</span>\n<span class=\"s1\">101: Value of: g_localPublishCount</span>\n<span class=\"s1\">101:   Actual: 3362832</span>\n<span class=\"s1\">101: Expected: g_totalExpectedMsgCount</span>\n<span class=\"s1\">101: Which is: 40000000</span>\n<span class=\"s1\">101: \u001b[1;32mMsg\u001b[0m Time to publish 20000 = 0 23202196</span>\n<span class=\"s1\">101: \u001b[1;32mMsg\u001b[0m Time to receive 3364223 = -8 -600090337</span>\n<span class=\"s1\">101: [  FAILED  ] TransportStressTest.ManyNodes (78543 ms)</span>\n</pre></div>\n\n\n<p>The NonDefaultWorld.Load appears to fail when run on a machine with no display (I test this by ssh'ing to my own machine). The test loads much more quickly and fails before pose messages can be received by ServerFixture for the HasEntity call. Here's a patch that fixes the test for me without a display:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"gh\">diff -r 237e08ff175c test/regression/nondefault_world.cc</span>\n<span class=\"gd\">--- a/test/regression/nondefault_world.cc   Tue Apr 09 16:18:31 2013 -0700</span>\n<span class=\"gi\">+++ b/test/regression/nondefault_world.cc   Tue Apr 09 18:00:33 2013 -0700</span>\n<span class=\"gu\">@@ -26,20 +26,12 @@</span>\n TEST_F(NonDefaultWorld, Load)\n {\n   math::Pose setPose, testPose;\n<span class=\"gd\">-  Load(&quot;worlds/empty_different_name.world&quot;);</span>\n<span class=\"gd\">-  SetPause(false);</span>\n<span class=\"gi\">+  Load(&quot;worlds/empty_different_name.world&quot;, true);</span>\n<span class=\"gi\">+  physics::WorldPtr world = physics::get_world(&quot;not_the_default_world_name&quot;);</span>\n<span class=\"gi\">+  ASSERT_TRUE(world != NULL);</span>\n\n<span class=\"gd\">-  int i = 0;</span>\n<span class=\"gd\">-</span>\n<span class=\"gd\">-  // Wait for the entity to spawn</span>\n<span class=\"gd\">-  while (!HasEntity(&quot;ground_plane&quot;) &amp;&amp; i &lt; 10)</span>\n<span class=\"gd\">-  {</span>\n<span class=\"gd\">-    common::Time::MSleep(100);</span>\n<span class=\"gd\">-    ++i;</span>\n<span class=\"gd\">-  }</span>\n<span class=\"gd\">-</span>\n<span class=\"gd\">-  EXPECT_TRUE(HasEntity(&quot;ground_plane&quot;));</span>\n<span class=\"gd\">-  EXPECT_LT(i, 10);</span>\n<span class=\"gi\">+  physics::ModelPtr model = world-&gt;GetModel(&quot;ground_plane&quot;);</span>\n<span class=\"gi\">+  ASSERT_TRUE(model);</span>\n }\n\n int main(int argc, char **argv)\n</pre></div>", "type": "rendered"}, "created_on": "2013-04-10T01:02:35.554884+00:00", "user": {"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}, "updated_on": "2013-04-10T01:02:35.562333+00:00", "type": "pullrequest_comment", "id": 191375}