{"rendered": {"description": {"raw": "Issue #1981 notes that if the center of gravity (CoG) of a link with joints is moved after the link, joints, etc. have been initialized, it causes the link to jerk suddenly. The problem occurs because Gazebo sets the origin of the ODE body as the link's CoG ([see here](#!/osrf/gazebo/src/c1c50dc2390e9b1fc168ca41a501db5b57119212/gazebo/physics/ode/ODELink.cc?at=default&fileviewer=file-view-default#ODELink.cc-253)). Thus, when the CoG is moved the ODE body's origin moves as well. Before the ODE joints are attached this is not a problem. However, once the joints have been initialized, moving the CoG causes joint constraints to be violated, so the model jumps to correct them.\r\n\r\nThe ODE function `dMassSetParameters` allows one to specify an offset for the CoG, so theoretically the changes in 479d04db6f74c12f0ba745abc2dda83f88ac50e4 would solve the issue. However, ODE does not support setting the CoG offset to anything but zero ([see here](http://ode.org/ode-latest-userguide.html#sec_13_0_0)).\r\n\r\n* ff62c8a allows link CoGs to be moved after initialization by reattaching the ODE joints when `ODELink::UpdateMass` is called. The collision meshes must also be updated, but this is already handled in `ODELink::UpdateCollisionOffsets`.\r\n\r\n* Reattaching the ODE joints resets the joint angles to zero for the current model configuration. This behavior shifts/breaks joint limits and makes the joint angles reported inconsistent. 2b3b1f6 maintains the joint limits and angles by keeping track of the angles of joints when they are reattached to the same parent and child links.\r\n\r\n* b7d3497 adds a test of the joint limits and angles when moving the CoG (i.e. the fix above).\r\n\r\n* 14c8f74 adds code to update the corresponding visuals when a link CoG is moved. It uses the `~/visual` topic, which may not be intended for CoG and inertia visuals but seemed the least intrusive avenue.  Commit 586ab8cd2976599a957c8c48b4acbe4049ed2bf4 (branch ode_move_cog2_test) has a plugin to check that the CoG visual is updated.\r\n\r\n* 59b776a merges the tests from pull request #2341, which now succeed.\r\n\r\n* 827c807 removes the logic that only reattaches the joints if the CoG has moved more than `1e-3` units since the CoG may move in small increments (e.g. internal actuator or liquid shifting within the link).", "markup": "markdown", "html": "<p>Issue <a href=\"#!/osrf/gazebo/issues/1981/moving-the-center-of-gravity-of-a-link\" rel=\"nofollow\" title=\"Moving the center of gravity of a link with joints results in false forces (ODE).\" class=\"ap-connect-link\">#1981</a> notes that if the center of gravity (CoG) of a link with joints is moved after the link, joints, etc. have been initialized, it causes the link to jerk suddenly. The problem occurs because Gazebo sets the origin of the ODE body as the link's CoG (<a data-is-external-link=\"true\" href=\"#!/osrf/gazebo/src/c1c50dc2390e9b1fc168ca41a501db5b57119212/gazebo/physics/ode/ODELink.cc?at=default&amp;fileviewer=file-view-default#ODELink.cc-253\" rel=\"nofollow\">see here</a>). Thus, when the CoG is moved the ODE body's origin moves as well. Before the ODE joints are attached this is not a problem. However, once the joints have been initialized, moving the CoG causes joint constraints to be violated, so the model jumps to correct them.</p>\n<p>The ODE function <code>dMassSetParameters</code> allows one to specify an offset for the CoG, so theoretically the changes in <a href=\"#!/osrf/gazebo/commits/479d04db6f74c12f0ba745abc2dda83f88ac50e4\" rel=\"nofollow\" class=\"ap-connect-link\">479d04db6f74c12f0ba745abc2dda83f88ac50e4</a> would solve the issue. However, ODE does not support setting the CoG offset to anything but zero (<a data-is-external-link=\"true\" href=\"http://ode.org/ode-latest-userguide.html#sec_13_0_0\" rel=\"nofollow\">see here</a>).</p>\n<ul>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/ff62c8a\" rel=\"nofollow\" class=\"ap-connect-link\">ff62c8a</a> allows link CoGs to be moved after initialization by reattaching the ODE joints when <code>ODELink::UpdateMass</code> is called. The collision meshes must also be updated, but this is already handled in <code>ODELink::UpdateCollisionOffsets</code>.</p>\n</li>\n<li>\n<p>Reattaching the ODE joints resets the joint angles to zero for the current model configuration. This behavior shifts/breaks joint limits and makes the joint angles reported inconsistent. <a href=\"#!/osrf/gazebo/commits/2b3b1f6\" rel=\"nofollow\" class=\"ap-connect-link\">2b3b1f6</a> maintains the joint limits and angles by keeping track of the angles of joints when they are reattached to the same parent and child links.</p>\n</li>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/b7d3497\" rel=\"nofollow\" class=\"ap-connect-link\">b7d3497</a> adds a test of the joint limits and angles when moving the CoG (i.e. the fix above).</p>\n</li>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/14c8f74\" rel=\"nofollow\" class=\"ap-connect-link\">14c8f74</a> adds code to update the corresponding visuals when a link CoG is moved. It uses the <code>~/visual</code> topic, which may not be intended for CoG and inertia visuals but seemed the least intrusive avenue.  Commit <a href=\"#!/osrf/gazebo/commits/586ab8cd2976599a957c8c48b4acbe4049ed2bf4\" rel=\"nofollow\" class=\"ap-connect-link\">586ab8cd2976599a957c8c48b4acbe4049ed2bf4</a> (branch ode_move_cog2_test) has a plugin to check that the CoG visual is updated.</p>\n</li>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/59b776a\" rel=\"nofollow\" class=\"ap-connect-link\">59b776a</a> merges the tests from <a href=\"#!/osrf/gazebo/pull-requests/2341/added-a-so-far-failing-test-for-moving-cog\" rel=\"nofollow\" class=\"ap-connect-link\">pull request #2341</a>, which now succeed.</p>\n</li>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/827c807\" rel=\"nofollow\" class=\"ap-connect-link\">827c807</a> removes the logic that only reattaches the joints if the CoG has moved more than <code>1e-3</code> units since the CoG may move in small increments (e.g. internal actuator or liquid shifting within the link).</p>\n</li>\n</ul>", "type": "rendered"}, "title": {"raw": "Moving the center of gravity of a link with joints in ODE", "markup": "markdown", "html": "<p>Moving the center of gravity of a link with joints in ODE</p>", "type": "rendered"}}, "type": "pullrequest", "description": "Issue #1981 notes that if the center of gravity (CoG) of a link with joints is moved after the link, joints, etc. have been initialized, it causes the link to jerk suddenly. The problem occurs because Gazebo sets the origin of the ODE body as the link's CoG ([see here](#!/osrf/gazebo/src/c1c50dc2390e9b1fc168ca41a501db5b57119212/gazebo/physics/ode/ODELink.cc?at=default&fileviewer=file-view-default#ODELink.cc-253)). Thus, when the CoG is moved the ODE body's origin moves as well. Before the ODE joints are attached this is not a problem. However, once the joints have been initialized, moving the CoG causes joint constraints to be violated, so the model jumps to correct them.\r\n\r\nThe ODE function `dMassSetParameters` allows one to specify an offset for the CoG, so theoretically the changes in 479d04db6f74c12f0ba745abc2dda83f88ac50e4 would solve the issue. However, ODE does not support setting the CoG offset to anything but zero ([see here](http://ode.org/ode-latest-userguide.html#sec_13_0_0)).\r\n\r\n* ff62c8a allows link CoGs to be moved after initialization by reattaching the ODE joints when `ODELink::UpdateMass` is called. The collision meshes must also be updated, but this is already handled in `ODELink::UpdateCollisionOffsets`.\r\n\r\n* Reattaching the ODE joints resets the joint angles to zero for the current model configuration. This behavior shifts/breaks joint limits and makes the joint angles reported inconsistent. 2b3b1f6 maintains the joint limits and angles by keeping track of the angles of joints when they are reattached to the same parent and child links.\r\n\r\n* b7d3497 adds a test of the joint limits and angles when moving the CoG (i.e. the fix above).\r\n\r\n* 14c8f74 adds code to update the corresponding visuals when a link CoG is moved. It uses the `~/visual` topic, which may not be intended for CoG and inertia visuals but seemed the least intrusive avenue.  Commit 586ab8cd2976599a957c8c48b4acbe4049ed2bf4 (branch ode_move_cog2_test) has a plugin to check that the CoG visual is updated.\r\n\r\n* 59b776a merges the tests from pull request #2341, which now succeed.\r\n\r\n* 827c807 removes the logic that only reattaches the joints if the CoG has moved more than `1e-3` units since the CoG may move in small increments (e.g. internal actuator or liquid shifting within the link).", "links": {"decline": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/pullrequests/2768/decline"}, "diffstat": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/diffstat/osrf/gazebo:119119e6e94b%0D5f48d294547f?from_pullrequest_id=2768"}, "commits": {"href": "data/repositories/osrf/gazebo/pullrequests/2768/commits.json"}, "self": {"href": "data/repositories/osrf/gazebo/pullrequests/2768.json"}, "comments": {"href": "data/repositories/osrf/gazebo/pullrequests/2768/comments_page=1.json"}, "merge": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/pullrequests/2768/merge"}, "html": {"href": "#!/osrf/gazebo/pull-requests/2768"}, "activity": {"href": "data/repositories/osrf/gazebo/pullrequests/2768/activity.json"}, "diff": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/diff/osrf/gazebo:119119e6e94b%0D5f48d294547f?from_pullrequest_id=2768"}, "approve": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/pullrequests/2768/approve"}, "statuses": {"href": "data/repositories/osrf/gazebo/pullrequests/2768/statuses_page=1.json"}}, "title": "Moving the center of gravity of a link with joints in ODE", "close_source_branch": false, "reviewers": [{"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}], "id": 2768, "destination": {"commit": {"hash": "5f48d294547f", "type": "commit", "links": {"self": {"href": "data/repositories/osrf/gazebo/commit/5f48d294547f.json"}, "html": {"href": "#!/osrf/gazebo/commits/5f48d294547f"}}}, "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "branch": {"name": "gazebo11"}}, "created_on": "2017-08-15T23:59:38.156868+00:00", "summary": {"raw": "Issue #1981 notes that if the center of gravity (CoG) of a link with joints is moved after the link, joints, etc. have been initialized, it causes the link to jerk suddenly. The problem occurs because Gazebo sets the origin of the ODE body as the link's CoG ([see here](#!/osrf/gazebo/src/c1c50dc2390e9b1fc168ca41a501db5b57119212/gazebo/physics/ode/ODELink.cc?at=default&fileviewer=file-view-default#ODELink.cc-253)). Thus, when the CoG is moved the ODE body's origin moves as well. Before the ODE joints are attached this is not a problem. However, once the joints have been initialized, moving the CoG causes joint constraints to be violated, so the model jumps to correct them.\r\n\r\nThe ODE function `dMassSetParameters` allows one to specify an offset for the CoG, so theoretically the changes in 479d04db6f74c12f0ba745abc2dda83f88ac50e4 would solve the issue. However, ODE does not support setting the CoG offset to anything but zero ([see here](http://ode.org/ode-latest-userguide.html#sec_13_0_0)).\r\n\r\n* ff62c8a allows link CoGs to be moved after initialization by reattaching the ODE joints when `ODELink::UpdateMass` is called. The collision meshes must also be updated, but this is already handled in `ODELink::UpdateCollisionOffsets`.\r\n\r\n* Reattaching the ODE joints resets the joint angles to zero for the current model configuration. This behavior shifts/breaks joint limits and makes the joint angles reported inconsistent. 2b3b1f6 maintains the joint limits and angles by keeping track of the angles of joints when they are reattached to the same parent and child links.\r\n\r\n* b7d3497 adds a test of the joint limits and angles when moving the CoG (i.e. the fix above).\r\n\r\n* 14c8f74 adds code to update the corresponding visuals when a link CoG is moved. It uses the `~/visual` topic, which may not be intended for CoG and inertia visuals but seemed the least intrusive avenue.  Commit 586ab8cd2976599a957c8c48b4acbe4049ed2bf4 (branch ode_move_cog2_test) has a plugin to check that the CoG visual is updated.\r\n\r\n* 59b776a merges the tests from pull request #2341, which now succeed.\r\n\r\n* 827c807 removes the logic that only reattaches the joints if the CoG has moved more than `1e-3` units since the CoG may move in small increments (e.g. internal actuator or liquid shifting within the link).", "markup": "markdown", "html": "<p>Issue <a href=\"#!/osrf/gazebo/issues/1981/moving-the-center-of-gravity-of-a-link\" rel=\"nofollow\" title=\"Moving the center of gravity of a link with joints results in false forces (ODE).\" class=\"ap-connect-link\">#1981</a> notes that if the center of gravity (CoG) of a link with joints is moved after the link, joints, etc. have been initialized, it causes the link to jerk suddenly. The problem occurs because Gazebo sets the origin of the ODE body as the link's CoG (<a data-is-external-link=\"true\" href=\"#!/osrf/gazebo/src/c1c50dc2390e9b1fc168ca41a501db5b57119212/gazebo/physics/ode/ODELink.cc?at=default&amp;fileviewer=file-view-default#ODELink.cc-253\" rel=\"nofollow\">see here</a>). Thus, when the CoG is moved the ODE body's origin moves as well. Before the ODE joints are attached this is not a problem. However, once the joints have been initialized, moving the CoG causes joint constraints to be violated, so the model jumps to correct them.</p>\n<p>The ODE function <code>dMassSetParameters</code> allows one to specify an offset for the CoG, so theoretically the changes in <a href=\"#!/osrf/gazebo/commits/479d04db6f74c12f0ba745abc2dda83f88ac50e4\" rel=\"nofollow\" class=\"ap-connect-link\">479d04db6f74c12f0ba745abc2dda83f88ac50e4</a> would solve the issue. However, ODE does not support setting the CoG offset to anything but zero (<a data-is-external-link=\"true\" href=\"http://ode.org/ode-latest-userguide.html#sec_13_0_0\" rel=\"nofollow\">see here</a>).</p>\n<ul>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/ff62c8a\" rel=\"nofollow\" class=\"ap-connect-link\">ff62c8a</a> allows link CoGs to be moved after initialization by reattaching the ODE joints when <code>ODELink::UpdateMass</code> is called. The collision meshes must also be updated, but this is already handled in <code>ODELink::UpdateCollisionOffsets</code>.</p>\n</li>\n<li>\n<p>Reattaching the ODE joints resets the joint angles to zero for the current model configuration. This behavior shifts/breaks joint limits and makes the joint angles reported inconsistent. <a href=\"#!/osrf/gazebo/commits/2b3b1f6\" rel=\"nofollow\" class=\"ap-connect-link\">2b3b1f6</a> maintains the joint limits and angles by keeping track of the angles of joints when they are reattached to the same parent and child links.</p>\n</li>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/b7d3497\" rel=\"nofollow\" class=\"ap-connect-link\">b7d3497</a> adds a test of the joint limits and angles when moving the CoG (i.e. the fix above).</p>\n</li>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/14c8f74\" rel=\"nofollow\" class=\"ap-connect-link\">14c8f74</a> adds code to update the corresponding visuals when a link CoG is moved. It uses the <code>~/visual</code> topic, which may not be intended for CoG and inertia visuals but seemed the least intrusive avenue.  Commit <a href=\"#!/osrf/gazebo/commits/586ab8cd2976599a957c8c48b4acbe4049ed2bf4\" rel=\"nofollow\" class=\"ap-connect-link\">586ab8cd2976599a957c8c48b4acbe4049ed2bf4</a> (branch ode_move_cog2_test) has a plugin to check that the CoG visual is updated.</p>\n</li>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/59b776a\" rel=\"nofollow\" class=\"ap-connect-link\">59b776a</a> merges the tests from <a href=\"#!/osrf/gazebo/pull-requests/2341/added-a-so-far-failing-test-for-moving-cog\" rel=\"nofollow\" class=\"ap-connect-link\">pull request #2341</a>, which now succeed.</p>\n</li>\n<li>\n<p><a href=\"#!/osrf/gazebo/commits/827c807\" rel=\"nofollow\" class=\"ap-connect-link\">827c807</a> removes the logic that only reattaches the joints if the CoG has moved more than <code>1e-3</code> units since the CoG may move in small increments (e.g. internal actuator or liquid shifting within the link).</p>\n</li>\n</ul>", "type": "rendered"}, "source": {"commit": {"hash": "119119e6e94b", "type": "commit", "links": {"self": {"href": "data/repositories/osrf/gazebo/commit/119119e6e94b.json"}, "html": {"href": "#!/osrf/gazebo/commits/119119e6e94b"}}}, "repository": {"links": {"self": {"href": "data/repositories/osrf/gazebo.json"}, "html": {"href": "#!/osrf/gazebo"}, "avatar": {"href": "data/bytebucket.org/ravatar/{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}ts=1694483"}}, "type": "repository", "name": "gazebo", "full_name": "osrf/gazebo", "uuid": "{51a0cd5d-8697-4eb1-8b08-e919ee881e1c}"}, "branch": {"name": "ode_move_cog2"}}, "comment_count": 2, "state": "DECLINED", "task_count": 0, "participants": [{"role": "REVIEWER", "participated_on": "2020-04-17T20:08:04.982515+00:00", "type": "participant", "approved": false, "user": {"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}}, {"role": "PARTICIPANT", "participated_on": "2020-01-23T21:05:26.857973+00:00", "type": "participant", "approved": false, "user": {"display_name": "Louise Poubel", "uuid": "{5cfa2075-477b-4ded-bdb9-8d2479544ec4}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B5cfa2075-477b-4ded-bdb9-8d2479544ec4%7D"}, "html": {"href": "https://bitbucket.org/%7B5cfa2075-477b-4ded-bdb9-8d2479544ec4%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:6ff86fcb-b7ab-44a5-b8a6-f6d9cae8b6e8/7d903d90-c5ea-4182-b7ef-0d467e9e1c74/128"}}, "nickname": "chapulina", "type": "user", "account_id": "557058:6ff86fcb-b7ab-44a5-b8a6-f6d9cae8b6e8"}}], "reason": "", "updated_on": "2020-04-17T20:08:14.110000+00:00", "author": {"display_name": "Peter Horak", "uuid": "{c72abe74-c12a-4128-a6fc-94f3844ac8ef}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bc72abe74-c12a-4128-a6fc-94f3844ac8ef%7D"}, "html": {"href": "https://bitbucket.org/%7Bc72abe74-c12a-4128-a6fc-94f3844ac8ef%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:451ed60b-3cfa-4a97-b4d3-a3fc34c2b21a/87d803b7-3e50-40c1-8159-a5c20abd84ea/128"}}, "nickname": "pchorak", "type": "user", "account_id": "557058:451ed60b-3cfa-4a97-b4d3-a3fc34c2b21a"}, "merge_commit": null, "closed_by": {"display_name": "Steve Peters", "uuid": "{2ccfed09-18b8-4921-8d58-15ef01092802}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D"}, "html": {"href": "https://bitbucket.org/%7B2ccfed09-18b8-4921-8d58-15ef01092802%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/1fb4816dad9e68337d3096f750951f6cd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsSP-1.png"}}, "nickname": "Steven Peters", "type": "user", "account_id": "557058:5de38267-b118-494c-aa76-4fab35448816"}}