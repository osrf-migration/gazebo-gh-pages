{"links": {"self": {"href": "data/repositories/osrf/gazebo/pullrequests/167/comments/58612.json"}, "html": {"href": "#!/osrf/gazebo/pull-requests/167/_/diff#comment-58612"}}, "parent": {"id": 58603, "links": {"self": {"href": "data/repositories/osrf/gazebo/pullrequests/167/comments/58603.json"}, "html": {"href": "#!/osrf/gazebo/pull-requests/167/_/diff#comment-58603"}}}, "deleted": false, "pullrequest": {"type": "pullrequest", "id": 167, "links": {"self": {"href": "data/repositories/osrf/gazebo/pullrequests/167.json"}, "html": {"href": "#!/osrf/gazebo/pull-requests/167"}}, "title": "Fix for issue #264, incorrect initial placement of collision with relative pose"}, "content": {"raw": "It was the initialization order in `Collision::Init()`, not doing `shape->Init()` first does not recurse into `ODECollision::OnPoseChange()` as `Link::Init()` calls children `Collision::Init()` which calls `Entity::SetWorldPoseDefault` which calls `Entity::UpdatePhysicsPose` which calls `this->OnPoseChange` that trickles down to `ODECollision::OnPoseChange` if it was initialized.\n\n~~~\n$ hg diff\ndiff -r c8974309a98d gazebo/physics/Collision.cc\n--- a/gazebo/physics/Collision.cc\tThu Dec 06 08:02:49 2012 -0800\n+++ b/gazebo/physics/Collision.cc\tThu Dec 06 18:58:53 2012 -0800\n@@ -109,10 +109,10 @@\n //////////////////////////////////////////////////\n void Collision::Init()\n {\n+  this->shape->Init();\n+\n   this->SetRelativePose(\n     this->sdf->GetValuePose(\"pose\"));\n-\n-  this->shape->Init();\n }\n \n //////////////////////////////////////////////////\ndiff -r c8974309a98d gazebo/physics/Link.cc\n--- a/gazebo/physics/Link.cc\tThu Dec 06 08:02:49 2012 -0800\n+++ b/gazebo/physics/Link.cc\tThu Dec 06 18:58:53 2012 -0800\n@@ -157,14 +157,9 @@\n //////////////////////////////////////////////////\n void Link::Init()\n {\n-  Base_V::iterator iter;\n-  for (iter = this->children.begin(); iter != this->children.end(); ++iter)\n-  {\n-    if ((*iter)->HasType(Base::COLLISION))\n-      boost::shared_static_cast<Collision>(*iter)->Init();\n-  }\n+  this->SetKinematic(this->sdf->GetValueBool(\"kinematic\"));\n \n-  this->SetKinematic(this->sdf->GetValueBool(\"kinematic\"));\n+  this->SetGravityMode(this->sdf->GetValueBool(\"gravity\"));\n \n   this->SetLinearDamping(this->GetLinearDamping());\n   this->SetAngularDamping(this->GetAngularDamping());\n@@ -231,6 +226,13 @@\n   // DO THIS LAST!\n   this->SetRelativePose(this->sdf->GetValuePose(\"pose\"));\n   this->SetInitialRelativePose(this->sdf->GetValuePose(\"pose\"));\n+\n+  Base_V::iterator iter;\n+  for (iter = this->children.begin(); iter != this->children.end(); ++iter)\n+  {\n+    if ((*iter)->HasType(Base::COLLISION))\n+      boost::shared_static_cast<Collision>(*iter)->Init();\n+  }\n }\n \n //////////////////////////////////////////////////\n~~~\n", "markup": "markdown", "html": "<p>It was the initialization order in <code>Collision::Init()</code>, not doing <code>shape-&gt;Init()</code> first does not recurse into <code>ODECollision::OnPoseChange()</code> as <code>Link::Init()</code> calls children <code>Collision::Init()</code> which calls <code>Entity::SetWorldPoseDefault</code> which calls <code>Entity::UpdatePhysicsPose</code> which calls <code>this-&gt;OnPoseChange</code> that trickles down to <code>ODECollision::OnPoseChange</code> if it was initialized.</p>\n<div class=\"codehilite\"><pre><span></span>$ hg diff\ndiff -r c8974309a98d gazebo/physics/Collision.cc\n--- a/gazebo/physics/Collision.cc   Thu Dec <span class=\"m\">06</span> <span class=\"m\">08</span>:02:49 <span class=\"m\">2012</span> -0800\n+++ b/gazebo/physics/Collision.cc   Thu Dec <span class=\"m\">06</span> <span class=\"m\">18</span>:58:53 <span class=\"m\">2012</span> -0800\n@@ -109,10 +109,10 @@\n //////////////////////////////////////////////////\n void Collision::Init<span class=\"o\">()</span>\n <span class=\"o\">{</span>\n+  this-&gt;shape-&gt;Init<span class=\"o\">()</span><span class=\"p\">;</span>\n+\n   this-&gt;SetRelativePose<span class=\"o\">(</span>\n     this-&gt;sdf-&gt;GetValuePose<span class=\"o\">(</span><span class=\"s2\">&quot;pose&quot;</span><span class=\"o\">))</span><span class=\"p\">;</span>\n-\n-  this-&gt;shape-&gt;Init<span class=\"o\">()</span><span class=\"p\">;</span>\n <span class=\"o\">}</span>\n\n //////////////////////////////////////////////////\ndiff -r c8974309a98d gazebo/physics/Link.cc\n--- a/gazebo/physics/Link.cc    Thu Dec <span class=\"m\">06</span> <span class=\"m\">08</span>:02:49 <span class=\"m\">2012</span> -0800\n+++ b/gazebo/physics/Link.cc    Thu Dec <span class=\"m\">06</span> <span class=\"m\">18</span>:58:53 <span class=\"m\">2012</span> -0800\n@@ -157,14 +157,9 @@\n //////////////////////////////////////////////////\n void Link::Init<span class=\"o\">()</span>\n <span class=\"o\">{</span>\n-  Base_V::iterator iter<span class=\"p\">;</span>\n-  <span class=\"k\">for</span> <span class=\"o\">(</span><span class=\"nv\">iter</span> <span class=\"o\">=</span> this-&gt;children.begin<span class=\"o\">()</span><span class=\"p\">;</span> iter !<span class=\"o\">=</span> this-&gt;children.end<span class=\"o\">()</span><span class=\"p\">;</span> ++iter<span class=\"o\">)</span>\n-  <span class=\"o\">{</span>\n-    <span class=\"k\">if</span> <span class=\"o\">((</span>*iter<span class=\"o\">)</span>-&gt;HasType<span class=\"o\">(</span>Base::COLLISION<span class=\"o\">))</span>\n-      boost::shared_static_cast&lt;Collision&gt;<span class=\"o\">(</span>*iter<span class=\"o\">)</span>-&gt;Init<span class=\"o\">()</span><span class=\"p\">;</span>\n-  <span class=\"o\">}</span>\n+  this-&gt;SetKinematic<span class=\"o\">(</span>this-&gt;sdf-&gt;GetValueBool<span class=\"o\">(</span><span class=\"s2\">&quot;kinematic&quot;</span><span class=\"o\">))</span><span class=\"p\">;</span>\n\n-  this-&gt;SetKinematic<span class=\"o\">(</span>this-&gt;sdf-&gt;GetValueBool<span class=\"o\">(</span><span class=\"s2\">&quot;kinematic&quot;</span><span class=\"o\">))</span><span class=\"p\">;</span>\n+  this-&gt;SetGravityMode<span class=\"o\">(</span>this-&gt;sdf-&gt;GetValueBool<span class=\"o\">(</span><span class=\"s2\">&quot;gravity&quot;</span><span class=\"o\">))</span><span class=\"p\">;</span>\n\n   this-&gt;SetLinearDamping<span class=\"o\">(</span>this-&gt;GetLinearDamping<span class=\"o\">())</span><span class=\"p\">;</span>\n   this-&gt;SetAngularDamping<span class=\"o\">(</span>this-&gt;GetAngularDamping<span class=\"o\">())</span><span class=\"p\">;</span>\n@@ -231,6 +226,13 @@\n   // DO THIS LAST!\n   this-&gt;SetRelativePose<span class=\"o\">(</span>this-&gt;sdf-&gt;GetValuePose<span class=\"o\">(</span><span class=\"s2\">&quot;pose&quot;</span><span class=\"o\">))</span><span class=\"p\">;</span>\n   this-&gt;SetInitialRelativePose<span class=\"o\">(</span>this-&gt;sdf-&gt;GetValuePose<span class=\"o\">(</span><span class=\"s2\">&quot;pose&quot;</span><span class=\"o\">))</span><span class=\"p\">;</span>\n+\n+  Base_V::iterator iter<span class=\"p\">;</span>\n+  <span class=\"k\">for</span> <span class=\"o\">(</span><span class=\"nv\">iter</span> <span class=\"o\">=</span> this-&gt;children.begin<span class=\"o\">()</span><span class=\"p\">;</span> iter !<span class=\"o\">=</span> this-&gt;children.end<span class=\"o\">()</span><span class=\"p\">;</span> ++iter<span class=\"o\">)</span>\n+  <span class=\"o\">{</span>\n+    <span class=\"k\">if</span> <span class=\"o\">((</span>*iter<span class=\"o\">)</span>-&gt;HasType<span class=\"o\">(</span>Base::COLLISION<span class=\"o\">))</span>\n+      boost::shared_static_cast&lt;Collision&gt;<span class=\"o\">(</span>*iter<span class=\"o\">)</span>-&gt;Init<span class=\"o\">()</span><span class=\"p\">;</span>\n+  <span class=\"o\">}</span>\n <span class=\"o\">}</span>\n\n //////////////////////////////////////////////////\n</pre></div>", "type": "rendered"}, "created_on": "2012-12-07T02:43:32.166271+00:00", "user": {"display_name": "John Hsu", "uuid": "{0a186eae-abf0-4514-a951-23db5eccc286}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B0a186eae-abf0-4514-a951-23db5eccc286%7D"}, "html": {"href": "https://bitbucket.org/%7B0a186eae-abf0-4514-a951-23db5eccc286%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:f3968cd3-4910-4384-8349-482a6c7889ec/5445ce6e-6273-47f0-84eb-621c86ca11cb/128"}}, "nickname": "hsu", "type": "user", "account_id": "557058:f3968cd3-4910-4384-8349-482a6c7889ec"}, "updated_on": "2012-12-07T03:04:23.247764+00:00", "type": "pullrequest_comment", "id": 58612}