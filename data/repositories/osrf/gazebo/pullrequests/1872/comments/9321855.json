{"links": {"self": {"href": "data/repositories/osrf/gazebo/pullrequests/1872/comments/9321855.json"}, "code": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/gazebo/diff/osrf/gazebo:fca284dbf144..0307cb9cabc8?path=gazebo%2Fcommon%2FBattery.cc"}, "html": {"href": "#!/osrf/gazebo/pull-requests/1872/_/diff#comment-9321855"}}, "deleted": false, "pullrequest": {"type": "pullrequest", "id": 1872, "links": {"self": {"href": "data/repositories/osrf/gazebo/pullrequests/1872.json"}, "html": {"href": "#!/osrf/gazebo/pull-requests/1872"}}, "title": "Add battery class (redo of pull request #1782)"}, "content": {"raw": "This method is mistaken because because consumer IDs are not unique:\n\n```\n#!c++\n\nid1 = battery->AddConsumer();\nid2 = battery->AddConsumer();\nbattery->RemoveConsumer(id1);\nid3 = battery->AddConsumer();\nassert(id3 != id2); // Fails\n```\n\nIt should be rewritten like this:\n\n\n```\n#!c++\n\nuint32_t consumerId = 0;\nauto iter = this->dataPtr->powerLoads.rbegin();\nif (iter != this->dataPtr->powerLoads.rend())\n  consumerId = iter->first + 1;\nreturn consumerId;\n```", "markup": "markdown", "html": "<p>This method is mistaken because because consumer IDs are not unique:</p>\n<div class=\"codehilite language-c++\"><pre><span></span><span class=\"n\">id1</span> <span class=\"o\">=</span> <span class=\"n\">battery</span><span class=\"o\">-&gt;</span><span class=\"n\">AddConsumer</span><span class=\"p\">();</span>\n<span class=\"n\">id2</span> <span class=\"o\">=</span> <span class=\"n\">battery</span><span class=\"o\">-&gt;</span><span class=\"n\">AddConsumer</span><span class=\"p\">();</span>\n<span class=\"n\">battery</span><span class=\"o\">-&gt;</span><span class=\"n\">RemoveConsumer</span><span class=\"p\">(</span><span class=\"n\">id1</span><span class=\"p\">);</span>\n<span class=\"n\">id3</span> <span class=\"o\">=</span> <span class=\"n\">battery</span><span class=\"o\">-&gt;</span><span class=\"n\">AddConsumer</span><span class=\"p\">();</span>\n<span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">id3</span> <span class=\"o\">!=</span> <span class=\"n\">id2</span><span class=\"p\">);</span> <span class=\"c1\">// Fails</span>\n</pre></div>\n\n\n<p>It should be rewritten like this:</p>\n<div class=\"codehilite language-c++\"><pre><span></span><span class=\"kt\">uint32_t</span> <span class=\"n\">consumerId</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"k\">auto</span> <span class=\"n\">iter</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">dataPtr</span><span class=\"o\">-&gt;</span><span class=\"n\">powerLoads</span><span class=\"p\">.</span><span class=\"n\">rbegin</span><span class=\"p\">();</span>\n<span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">iter</span> <span class=\"o\">!=</span> <span class=\"k\">this</span><span class=\"o\">-&gt;</span><span class=\"n\">dataPtr</span><span class=\"o\">-&gt;</span><span class=\"n\">powerLoads</span><span class=\"p\">.</span><span class=\"n\">rend</span><span class=\"p\">())</span>\n  <span class=\"n\">consumerId</span> <span class=\"o\">=</span> <span class=\"n\">iter</span><span class=\"o\">-&gt;</span><span class=\"n\">first</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"k\">return</span> <span class=\"n\">consumerId</span><span class=\"p\">;</span>\n</pre></div>", "type": "rendered"}, "created_on": "2015-08-24T14:45:41.647503+00:00", "user": {"display_name": "Olivier Crave", "uuid": "{c2c9ac10-3ca6-45ef-a19b-d3a76d065296}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bc2c9ac10-3ca6-45ef-a19b-d3a76d065296%7D"}, "html": {"href": "https://bitbucket.org/%7Bc2c9ac10-3ca6-45ef-a19b-d3a76d065296%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/a4e0f2b75ca0affe5c82b9650a623d0dd=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsOC-4.png"}}, "nickname": "ocrave", "type": "user", "account_id": "557058:24cd6b3d-30bb-4c42-9e4b-f5836c392874"}, "inline": {"to": 86, "from": null, "outdated": true, "path": "gazebo/common/Battery.cc"}, "updated_on": "2015-08-24T14:46:05.900724+00:00", "type": "pullrequest_comment", "id": 9321855}